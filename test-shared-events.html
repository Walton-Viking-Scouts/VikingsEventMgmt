<!DOCTYPE html>
<html>
<head>
    <title>Test Shared Events Demo Data</title>
</head>
<body>
    <h1>Testing Shared Events Demo Data</h1>
    <div id="results"></div>
    
    <script type="module">
        // Import the demo mode functions
        import { initializeDemoMode } from './src/config/demoMode.js';
        
        // Clear localStorage first
        localStorage.clear();
        console.log('Cleared localStorage');
        
        // Initialize demo mode
        const initialized = await initializeDemoMode();
        console.log('Demo mode initialized:', initialized);
        
        // Check what was stored
        const results = [];
        
        // Check sections
        const sections = localStorage.getItem('viking_sections_offline');
        if (sections) {
            const parsed = JSON.parse(sections);
            results.push(`✅ Sections stored: ${parsed.length} sections`);
            console.log('Sections:', parsed);
        } else {
            results.push('❌ No sections found');
        }
        
        // Check Swimming Gala metadata for each section
        const sectionIds = [11107, 63813, 11113, 49097];
        sectionIds.forEach(sectionId => {
            // Swimming Gala is event index 2 (second event)
            const eventId = `demo_event_${sectionId}_2`;
            const metadataKey = `viking_shared_metadata_${eventId}`;
            const metadata = localStorage.getItem(metadataKey);
            
            if (metadata) {
                const parsed = JSON.parse(metadata);
                results.push(`✅ Metadata for section ${sectionId}: isOwner=${parsed._isOwner}, sections=${parsed._allSections?.length}`);
                console.log(`Metadata for ${eventId}:`, parsed);
            } else {
                results.push(`❌ No metadata for section ${sectionId} (key: ${metadataKey})`);
            }
        });
        
        // Check shared attendance cache
        sectionIds.forEach(sectionId => {
            const eventId = `demo_event_${sectionId}_2`;
            const cacheKey = `viking_shared_attendance_${eventId}_${sectionId}_offline`;
            const cache = localStorage.getItem(cacheKey);
            
            if (cache) {
                const parsed = JSON.parse(cache);
                results.push(`✅ Shared attendance for section ${sectionId}: ${parsed.items?.length} attendees`);
                
                // Check for external section attendees
                const externalAttendees = parsed.items?.filter(item => 
                    item.sectionid === 'external_scouts_001' || 
                    item.groupname === '2nd Elmbridge Scout Group'
                );
                if (externalAttendees?.length > 0) {
                    results.push(`  ↳ External section attendees: ${externalAttendees.length}`);
                }
            } else {
                results.push(`❌ No shared attendance for section ${sectionId} (key: ${cacheKey})`);
            }
        });
        
        // Display results
        document.getElementById('results').innerHTML = '<pre>' + results.join('\n') + '</pre>';
        
        // Also check if external section appears in any metadata
        const adultsEventId = 'demo_event_11107_2';
        const adultsMetadataKey = `viking_shared_metadata_${adultsEventId}`;
        const adultsMetadata = localStorage.getItem(adultsMetadataKey);
        if (adultsMetadata) {
            const parsed = JSON.parse(adultsMetadata);
            const externalSection = parsed._allSections?.find(s => s.sectionid === 'external_scouts_001');
            if (externalSection) {
                console.log('✅ External section found in metadata:', externalSection);
                results.push(`\n✅ External section in metadata: ${externalSection.sectionname} (${externalSection.attendance} attending)`);
            } else {
                console.log('❌ External section NOT found in metadata');
                results.push('\n❌ External section NOT found in metadata');
            }
        }
        
        // Update display
        document.getElementById('results').innerHTML = '<pre>' + results.join('\n') + '</pre>';
    </script>
</body>
</html>