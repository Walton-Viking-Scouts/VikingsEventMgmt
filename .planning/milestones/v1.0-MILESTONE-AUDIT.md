---
milestone: v1.0
audited: 2026-02-17
status: tech_debt
scores:
  requirements: 38/40
  phases: 7/7
  integration: 41/44
  flows: 6/7
gaps:
  requirements:
    - "SECT-02: SQLite sections — not verified (web-only deployment, SQLite untested)"
    - "EVNT-03: SQLite events — not verified (web-only deployment, SQLite untested)"
    - "ATTN-03: SQLite attendance — not verified (web-only deployment, SQLite untested)"
    - "TERM-03: SQLite terms table never created in createTables() — SQLITE_SCHEMAS.terms missing"
    - "FLEX-05: SQLite flexi methods — table creation works but end-to-end untested"
  integration:
    - "SQLITE_SCHEMAS.terms not executed in createTables() — native terms storage broken"
    - "STORES.SHARED_ATTENDANCE references deleted store — causes Sentry noise on logout"
    - "NORMALIZED_STORES constant orphaned — zero callers outside schema file"
  flows:
    - "Flow 5 (native): View movements breaks — terms table missing on SQLite"
tech_debt:
  - phase: 06-flexi-records-normalization
    items:
      - "FlexiRecordDataService.getFlexiRecordLists() has shape mismatch bug (zero callers, latent)"
  - phase: 07-cleanup-consolidation
    items:
      - "attendanceHelpers_new.js orphaned (80 lines, zero imports)"
      - "STORES.SHARED_ATTENDANCE constant references deleted store"
---

# Milestone v1.0 Audit: Data Storage Normalization

## Executive Summary

All 7 phases completed. 21/21 plans executed with summaries. All IndexedDB normalization is fully wired and verified on web. SQLite/native platform has a critical gap (terms table not created) and is otherwise untested. No VERIFICATION.md files exist (verifier was disabled in config).

## Requirements Coverage

### Schema & Infrastructure (6/6)

| Requirement | Phase | Status |
|-------------|-------|--------|
| INFR-01: IndexedDB schema bumped | Phase 1 | **Satisfied** — DATABASE_VERSION = 8 |
| INFR-02: SQLite schema updated | Phase 1 | **Partial** — flexi tables created, terms table missing |
| INFR-03: Demo mode same schema | Phase 1 | **Satisfied** — separate DB name, same upgrade logic |
| INFR-04: Zod validation schemas | Phase 1 | **Satisfied** — 7 schemas + safeParseArray |
| XCUT-01: Consistent error handling | Phase 1 | **Satisfied** — Sentry on all storage operations |
| XCUT-04: DatabaseService facade | Phase 1 | **Satisfied** — all data types covered |

### Sections (4/4)

| Requirement | Phase | Status |
|-------------|-------|--------|
| SECT-01: IndexedDB sections store | Phase 2 | **Satisfied** |
| SECT-02: SQLite sections store | Phase 2 | **Unverified** — code exists, untested on native |
| SECT-03: Bulk upsert atomic | Phase 2 | **Satisfied** |
| SECT-04: Consistent query shapes | Phase 2 | **Satisfied** (IndexedDB verified) |

### Events (5/5)

| Requirement | Phase | Status |
|-------------|-------|--------|
| EVNT-01: IndexedDB events store | Phase 3 | **Satisfied** |
| EVNT-02: Events indexed | Phase 3 | **Satisfied** — sectionid, termid, startdate |
| EVNT-03: SQLite events store | Phase 3 | **Unverified** |
| EVNT-04: Bulk upsert per section | Phase 3 | **Satisfied** |
| EVNT-05: Query methods both platforms | Phase 3 | **Satisfied** (IndexedDB verified) |

### Attendance (6/6)

| Requirement | Phase | Status |
|-------------|-------|--------|
| ATTN-01: IndexedDB compound key | Phase 4 | **Satisfied** — [eventid, scoutid] |
| ATTN-02: Compound indexes | Phase 4 | **Satisfied** |
| ATTN-03: SQLite attendance | Phase 4 | **Unverified** |
| ATTN-04: Shared attendance records | Phase 4 | **Satisfied** — shared_event_metadata store |
| ATTN-05: Bulk upsert per event | Phase 4 | **Satisfied** |
| ATTN-06: Consistent query shapes | Phase 4 | **Satisfied** (IndexedDB verified) |

### Terms (5/5)

| Requirement | Phase | Status |
|-------------|-------|--------|
| TERM-01: IndexedDB terms store | Phase 5 | **Satisfied** |
| TERM-02: Terms indexed | Phase 5 | **Satisfied** — sectionid, startdate |
| TERM-03: SQLite terms store | Phase 5 | **Gap** — table never created in createTables() |
| TERM-04: CurrentActiveTermsService | Phase 5 | **Satisfied** |
| TERM-05: Consistent query shapes | Phase 5 | **Satisfied** (IndexedDB verified) |

### Flexi Records (7/7)

| Requirement | Phase | Status |
|-------------|-------|--------|
| FLEX-01: Flexi lists compound key | Phase 6 | **Satisfied** — [sectionid, extraid] |
| FLEX-02: Flexi structures by extraid | Phase 6 | **Satisfied** |
| FLEX-03: Flexi data compound key | Phase 6 | **Satisfied** — [extraid, sectionid, termid] |
| FLEX-04: Secondary indexes | Phase 6 | **Satisfied** |
| FLEX-05: SQLite flexi methods | Phase 6 | **Partial** — tables created, methods exist, untested |
| FLEX-06: FlexiRecordDataService single source | Phase 6 | **Satisfied** — UnifiedStorageService deleted |
| FLEX-07: Flexi bulk upsert methods | Phase 6 | **Satisfied** |

### Cleanup (5/5)

| Requirement | Phase | Status |
|-------------|-------|--------|
| CLNP-01: No blob storage keys | Phase 7 | **Satisfied** — grep verified zero references |
| CLNP-02: UnifiedStorageService removed | Phase 7 | **Satisfied** — file deleted, zero imports |
| CLNP-03: No localStorage fallbacks | Phase 7 | **Satisfied** — only demo mode reads remain |
| CLNP-04: No dual-write paths | Phase 7 | **Satisfied** |
| CLNP-05: All consumers updated | Phase 7 | **Satisfied** |

### Cross-Cutting (3/3)

| Requirement | Phase | Status |
|-------------|-------|--------|
| XCUT-02: Single write path | Phase 7 | **Satisfied** — API → validate → normalize → store |
| XCUT-03: Consistent shapes | Phase 7 | **Satisfied** (IndexedDB verified) |
| XCUT-04: DatabaseService facade | Phase 1 | **Satisfied** |

## Cross-Phase Integration

### Verified Wiring (41/44 connected)

- Zod schemas imported at all 7 write boundaries in database.js
- All API endpoints write through DatabaseService → IndexedDB
- IndexedDB upgrade path v4→v5→v6→v7→v8 handles incremental migrations
- Demo mode uses separate database with identical schema
- UnifiedStorageService fully removed (zero references)
- All consumer files migrated to normalized storage
- Logout clears all IndexedDB stores via Promise.allSettled

### Issues Found (3)

| Issue | Severity | Impact |
|-------|----------|--------|
| `SQLITE_SCHEMAS.terms` not in `createTables()` | Critical (native only) | Terms can't be stored on iOS/Android |
| `STORES.SHARED_ATTENDANCE` references deleted store | Info | Sentry noise on every logout |
| `NORMALIZED_STORES` constant orphaned | Info | Dead documentation code |

## E2E Flow Verification

| Flow | Status | Notes |
|------|--------|-------|
| 1. Login → sections → display | **Pass** | Sections stored as individual records |
| 2. Select section → events → display | **Pass** | Events indexed by sectionid |
| 3. View event → attendance → display | **Pass** | Compound key [eventid, scoutid] |
| 4. Sign in/out → flexi record write | **Pass** | Per-section field mapping resolved |
| 5. View movements → flexi structures | **Fail (native)** | Terms table missing breaks term resolution |
| 6. Logout → clear stores | **Pass** | allSettled handles stale store gracefully |
| 7. Offline → read cached data | **Pass** | All data types readable from IndexedDB |

## Tech Debt

### Phase 6: Flexi Records
- `FlexiRecordDataService.getFlexiRecordLists()` has shape mismatch bug — treats `{ items }` result as iterable array. Zero callers, latent only.

### Phase 7: Cleanup
- `attendanceHelpers_new.js` — 80-line orphaned file with `_new` suffix, zero imports anywhere
- `STORES.SHARED_ATTENDANCE` constant references a store that was deleted in v6 upgrade — causes harmless but noisy Sentry errors on every logout

## Deferred Items (from phase execution)

- DB version test assertions (v7→v8) — **already fixed** in PR #174 review

## Recommendation

**Status: tech_debt** — All IndexedDB/web requirements are satisfied. SQLite/native has one critical gap (terms table) and is otherwise untested but code exists. Since the app currently deploys as web-only via Capacitor, the native gaps are non-blocking for production but should be tracked for future native deployment.
