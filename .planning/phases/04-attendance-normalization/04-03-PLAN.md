---
phase: 04-attendance-normalization
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/shared/services/data/attendanceDataService.js
  - src/shared/services/data/eventDataLoader.js
  - src/shared/utils/attendanceHelpers_new.js
  - src/features/events/hooks/useAttendanceData.js
  - src/features/events/hooks/useSharedAttendance.js
  - src/shared/services/api/api/events.js
autonomous: true

must_haves:
  truths:
    - "attendanceDataService.attendanceCache is removed -- all reads go through IndexedDB/SQLite"
    - "eventDataLoader writes attendance to normalized store via DatabaseService, not USS blobs"
    - "useAttendanceData reads shared attendance from normalized store, not USS blob keys"
    - "useSharedAttendance reads shared metadata from shared_event_metadata store, not USS blob keys"
    - "Read-time enrichment joins event/section data instead of reading stored enrichment fields"
    - "No code writes attendance through UnifiedStorageService blob keys"
  artifacts:
    - path: "src/shared/services/data/attendanceDataService.js"
      provides: "Cache removal, reads via DatabaseService"
    - path: "src/shared/services/data/eventDataLoader.js"
      provides: "Normalized store writes for attendance sync"
    - path: "src/shared/utils/attendanceHelpers_new.js"
      provides: "Read-time enrichment joining events/sections"
    - path: "src/features/events/hooks/useAttendanceData.js"
      provides: "Reads shared attendance from normalized store"
    - path: "src/features/events/hooks/useSharedAttendance.js"
      provides: "Reads shared metadata from shared_event_metadata store"
    - path: "src/shared/services/api/api/events.js"
      provides: "Shared attendance API writes to normalized store"
  key_links:
    - from: "src/shared/services/data/eventDataLoader.js"
      to: "DatabaseService.saveAttendance"
      via: "sync writes attendance to normalized store"
      pattern: "saveAttendance|saveSharedAttendance"
    - from: "src/features/events/hooks/useAttendanceData.js"
      to: "DatabaseService.getAttendance"
      via: "hook reads from normalized store"
      pattern: "getAttendance|getAttendanceByEvent"
    - from: "src/features/events/hooks/useSharedAttendance.js"
      to: "DatabaseService.getSharedEventMetadata"
      via: "hook reads shared metadata from new store"
      pattern: "getSharedEventMetadata"
---

<objective>
Update all attendance consumers (data services, hooks, API layer, helpers) to read from and write to the normalized attendance store via DatabaseService, removing all UnifiedStorageService blob key references, the in-memory attendanceCache, and stored enrichment fields.

Purpose: Complete the migration by connecting all code paths to the normalized store. After this plan, no code reads or writes attendance through USS blob keys. The in-memory cache is removed in favor of direct IndexedDB/SQLite reads.

Output: All 6 consumer files updated, USS attendance blob paths become dead code.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-attendance-normalization/04-RESEARCH.md
@.planning/phases/04-attendance-normalization/04-02-SUMMARY.md

@src/shared/services/data/attendanceDataService.js
@src/shared/services/data/eventDataLoader.js
@src/shared/utils/attendanceHelpers_new.js
@src/features/events/hooks/useAttendanceData.js
@src/features/events/hooks/useSharedAttendance.js
@src/shared/services/api/api/events.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update data services -- remove cache, write to normalized store</name>
  <files>
    src/shared/services/data/attendanceDataService.js
    src/shared/services/data/eventDataLoader.js
    src/shared/utils/attendanceHelpers_new.js
  </files>
  <action>
**attendanceDataService.js:**
1. Remove the `attendanceCache` Map (around line 9) and all references to it throughout the file.
2. Update `loadAttendanceFromCache(eventId)` (or equivalent method that loads attendance for display) to call `databaseService.getAttendance(eventId)` instead of reading from USS blob keys or the in-memory cache.
3. Any method that currently writes to `attendanceCache` should be updated to either remove the write or route through `databaseService.saveAttendance()`.
4. If `getCachedEventsOptimized` or similar methods reference the cache, update them to read from the DatabaseService.
5. Do NOT remove the methods themselves (they are the public API) -- just change their internal implementation to use DatabaseService instead of USS/cache.

**eventDataLoader.js:**
1. Update `syncEventAttendance(event, token)` (or equivalent) to write attendance to `databaseService.saveAttendance(eventId, records)` instead of USS blob keys.
   - The records passed to saveAttendance should contain only core fields (scoutid, eventid, sectionid, attending, patrol, notes) -- do NOT include enrichment fields (eventname, eventdate, sectionname).
   - The eventId and sectionid should be added to each record from the event object before saving.
2. Update `syncSharedAttendance(event, token)` to write shared attendance to `databaseService.saveSharedAttendance(eventId, records)` with `isSharedSection: true` marker on each record.
   - Also save shared event metadata via `databaseService.saveSharedEventMetadata({ eventid, isSharedEvent: true, ownerSectionId, sections: [...] })`.
3. Remove any USS.set() calls for attendance blob keys (`viking_attendance_*_offline`, `viking_shared_attendance_*_offline`).
4. If there is a batch-sync-all-attendance flow, leave it in place but note it as dead code to be cleaned up in Phase 7 (the on-demand pattern per user decision means this path should rarely trigger, but removing it is out of scope for this plan -- just ensure new writes go through the normalized path).

**attendanceHelpers_new.js:**
1. Update `loadAllAttendanceFromDatabase` (around line 21) to perform read-time enrichment:
   - Get raw attendance records from `databaseService.getAttendance(eventId)` (no enrichment fields stored)
   - Join with event data: call `databaseService.getEventById(eventId)` to get event name, date, sectionid
   - Enrich each record: `{ ...record, eventname: event?.name, eventdate: event?.startdate, sectionname: null }`
   - If sectionname is needed, look it up from sections store (optional -- may just pass null and let UI handle)
2. Remove any direct USS reads for attendance data.
3. Ensure the enrichment happens at the function level, not stored back to IndexedDB.
  </action>
  <verify>
Run `npm run lint` from the project directory. No new lint errors. Grep for `attendanceCache` in attendanceDataService.js -- should not exist. Grep for `UnifiedStorageService` references related to attendance in the modified files -- should not exist for attendance reads/writes (other USS usage for non-attendance data is fine to remain).
  </verify>
  <done>
attendanceDataService has no in-memory cache -- all reads go through DatabaseService to IndexedDB/SQLite. eventDataLoader writes core-fields-only attendance records to normalized store. Shared attendance writes include isSharedSection marker and shared event metadata. attendanceHelpers_new.js enriches records at read time by joining with events store.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update hooks and API layer to read from normalized store</name>
  <files>
    src/features/events/hooks/useAttendanceData.js
    src/features/events/hooks/useSharedAttendance.js
    src/shared/services/api/api/events.js
  </files>
  <action>
**useAttendanceData.js:**
1. Find the section that reads shared attendance from USS (around lines 61-87 per research). Replace USS.get('viking_shared_attendance_{eventId}_{sectionId}_offline') calls with `databaseService.getAttendance(eventId)` and then filter results for `isSharedSection === true`.
2. Update any other USS blob key reads for regular attendance to use `databaseService.getAttendance(eventId)`.
3. Ensure the hook continues to return the same data shape to components (the enrichment happens at the helpers layer or inline).
4. Remove USS imports if they were only used for attendance in this file.

**useSharedAttendance.js:**
1. Find the shared metadata check (around line 19 per research). Replace `UnifiedStorageService.get('viking_shared_metadata_{eventId}')` with `databaseService.getSharedEventMetadata(eventId)`.
2. The `hasSharedEvents` check should now use the result from the new store (truthy = has shared events).
3. Replace any USS reads for shared section lists with `metadata.sections` from the shared_event_metadata store.
4. Remove USS imports if only used for attendance/shared metadata.

**events.js (API layer):**
1. Find `getSharedEventAttendance` or similar function that currently writes shared attendance to USS blob keys.
2. Update it to call `databaseService.saveSharedAttendance(eventId, records)` for the attendance data.
3. Update it to call `databaseService.saveSharedEventMetadata(metadata)` for the shared event metadata.
4. In `createMemberSectionRecordsForSharedAttendees` or equivalent, ensure the sectionid field is correctly mapped from the shared API response (the shared API may use different field names).
5. Remove USS.set() calls for shared attendance blob keys.
6. Keep the API fetch logic intact -- only change where the data is stored after fetching.
  </action>
  <verify>
Run `npm run lint` from the project directory. No new lint errors. Grep across all modified files for `viking_attendance_` and `viking_shared_attendance_` and `viking_shared_metadata_` string patterns -- should not appear in read/write operations (may still appear in comments which is OK). Run `npm run test:run` to ensure no existing tests break.
  </verify>
  <done>
useAttendanceData reads shared attendance from normalized store filtering by isSharedSection marker. useSharedAttendance reads shared metadata from shared_event_metadata store. events.js API layer writes fetched shared attendance and metadata to normalized stores via DatabaseService. No hook or API layer code references USS blob keys for attendance data.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. `npm run test:run` passes (no regressions)
3. Grep for `attendanceCache` in codebase -- not found in attendanceDataService.js
4. Grep for USS attendance blob key patterns (`viking_attendance_.*_offline`, `viking_shared_attendance_`, `viking_shared_metadata_`) in write/read operations -- not found in any modified file
5. useAttendanceData uses DatabaseService for shared attendance reads
6. useSharedAttendance uses DatabaseService for shared metadata reads
7. eventDataLoader uses DatabaseService.saveAttendance for writes
8. attendanceHelpers_new.js enriches at read time from events store
</verification>

<success_criteria>
All attendance consumers connected to normalized store. No code reads or writes attendance through USS blob keys. In-memory cache removed. Read-time enrichment replaces stored enrichment fields. The attendance data path is fully normalized: API -> validate -> store individual records -> read with enrichment joins.
</success_criteria>

<output>
After completion, create `.planning/phases/04-attendance-normalization/04-03-SUMMARY.md`
</output>
