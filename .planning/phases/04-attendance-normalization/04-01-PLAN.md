---
phase: 04-attendance-normalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/services/storage/schemas/validation.js
  - src/shared/services/storage/schemas/indexedDBSchema.js
  - src/shared/services/storage/schemas/sqliteSchema.js
  - src/shared/services/storage/indexedDBService.js
autonomous: true

must_haves:
  truths:
    - "Attendance store uses compound keyPath [eventid, scoutid] after v6 upgrade"
    - "Shared attendance store is deleted and records will go into unified attendance store"
    - "shared_event_metadata store exists keyed by eventid"
    - "Old localStorage blob keys for attendance are cleaned up during upgrade"
    - "IndexedDBService has working CRUD methods for attendance with compound key lookups"
    - "AttendanceSchema validates core fields only with attending normalization and passthrough"
  artifacts:
    - path: "src/shared/services/storage/indexedDBService.js"
      provides: "v6 upgrade block, attendance CRUD methods, shared_event_metadata CRUD"
    - path: "src/shared/services/storage/schemas/validation.js"
      provides: "Updated AttendanceSchema with core fields, attending transform, passthrough"
    - path: "src/shared/services/storage/schemas/indexedDBSchema.js"
      provides: "Updated NORMALIZED_STORES with attendance compound key and shared_event_metadata"
    - path: "src/shared/services/storage/schemas/sqliteSchema.js"
      provides: "shared_event_metadata table definition"
  key_links:
    - from: "src/shared/services/storage/indexedDBService.js"
      to: "STORES.ATTENDANCE"
      via: "v6 upgrade block replaces store with compound keyPath"
      pattern: "keyPath.*eventid.*scoutid"
    - from: "src/shared/services/storage/indexedDBService.js"
      to: "bulkReplaceAttendanceForEvent"
      via: "cursor-based per-event delete + insert"
      pattern: "index\\.openCursor.*eventId"
---

<objective>
Add attendance Zod schemas, IndexedDB v6 store migration (compound key [eventid, scoutid], shared_event_metadata store, old blob cleanup), and all IndexedDBService CRUD methods for attendance and shared event metadata.

Purpose: Foundation layer for attendance normalization -- schemas define data shape, IndexedDB store migration creates the physical stores, CRUD methods enable the DatabaseService layer (Plan 02) to read/write.

Output: Updated schemas, v6 upgrade block in indexedDBService.js, 6+ new static methods on IndexedDBService.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-attendance-normalization/04-RESEARCH.md
@.planning/phases/03-events-normalization/03-01-SUMMARY.md

@src/shared/services/storage/schemas/validation.js
@src/shared/services/storage/schemas/indexedDBSchema.js
@src/shared/services/storage/schemas/sqliteSchema.js
@src/shared/services/storage/indexedDBService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Zod schemas and schema constants for attendance</name>
  <files>
    src/shared/services/storage/schemas/validation.js
    src/shared/services/storage/schemas/indexedDBSchema.js
    src/shared/services/storage/schemas/sqliteSchema.js
  </files>
  <action>
**validation.js -- Update AttendanceSchema:**
Replace the existing AttendanceSchema (around lines 44-52) with a core-fields-only schema:
- `scoutid`: z.union([z.string(), z.number()]).transform(Number)
- `eventid`: z.union([z.string(), z.number()]).transform(String)
- `sectionid`: z.union([z.string(), z.number()]).transform(Number)
- `attending`: z.union([z.string(), z.number()]).transform(val => { normalize: "yes"/"1"/"true" -> "Yes", "no"/"0"/"false" -> "No", "invited" -> "Invited", "shown"/"show in my.scout" -> "Shown", else preserve as lowercase string }).nullable().optional()
- `patrol`: z.string().nullable().optional()
- `notes`: z.string().nullable().optional()
- Add `.passthrough()` at the end to allow unknown fields through

Remove `firstname` and `lastname` from AttendanceSchema (enrichment fields -- join at read time).

**validation.js -- Add SharedEventMetadataSchema:**
Add a new exported schema:
- `eventid`: z.union([z.string(), z.number()]).transform(String)
- `isSharedEvent`: z.boolean().optional().default(true)
- `ownerSectionId`: z.union([z.string(), z.number()]).transform(Number).nullable().optional()
- `sections`: z.array(z.object({ sectionid: z.union([z.string(), z.number()]).transform(Number), sectionname: z.string().nullable().optional() }).passthrough()).optional().default([])

**indexedDBSchema.js -- Update NORMALIZED_STORES:**
- Verify that `attendance` entry has `keyPath: ['eventid', 'scoutid']` and `indexes` include `eventid`, `scoutid`, `sectionid`
- Replace the `shared_attendance` entry with `shared_event_metadata: { keyPath: 'eventid', indexes: [] }`
- Add a STORES constant entry for `shared_event_metadata` if not already defined

**sqliteSchema.js -- Add shared_event_metadata:**
- Add a `shared_event_metadata` table: `CREATE TABLE IF NOT EXISTS shared_event_metadata (eventid TEXT PRIMARY KEY, is_shared_event INTEGER DEFAULT 1, owner_section_id INTEGER, sections TEXT, updated_at INTEGER)`
- Add to SQLITE_INDEXES if needed (no secondary indexes needed for this small table)
  </action>
  <verify>
Run `npm run lint` from the project directory. No new lint errors in the modified files. Import the schemas in a quick mental check -- AttendanceSchema should accept {scoutid: "123", eventid: 456, sectionid: "789", attending: "yes"} and transform to {scoutid: 123, eventid: "456", sectionid: 789, attending: "Yes"}.
  </verify>
  <done>
AttendanceSchema defines only core fields (scoutid, eventid, sectionid, attending, patrol, notes) with passthrough, attending normalization transform, and no enrichment fields. SharedEventMetadataSchema exists. indexedDBSchema.js defines attendance with compound key and shared_event_metadata store. sqliteSchema.js has shared_event_metadata table.
  </done>
</task>

<task type="auto">
  <name>Task 2: IndexedDB v6 upgrade block and attendance CRUD methods</name>
  <files>
    src/shared/services/storage/indexedDBService.js
  </files>
  <action>
**DB Version Bump:**
Change `DATABASE_VERSION` from 5 to 6.

**v6 Upgrade Block (after the existing `if (oldVersion < 5)` block):**
Add `if (oldVersion < 6)` block that:
1. Deletes existing attendance store if it exists: `if (db.objectStoreNames.contains(STORES.ATTENDANCE)) { db.deleteObjectStore(STORES.ATTENDANCE); }`
2. Creates normalized attendance store: `db.createObjectStore(STORES.ATTENDANCE, { keyPath: ['eventid', 'scoutid'] })` with indexes on `eventid` (unique: false), `scoutid` (unique: false), `sectionid` (unique: false)
3. Deletes `shared_attendance` store if it exists: `if (db.objectStoreNames.contains(STORES.SHARED_ATTENDANCE)) { db.deleteObjectStore(STORES.SHARED_ATTENDANCE); }`
4. Creates `shared_event_metadata` store: `db.createObjectStore('shared_event_metadata', { keyPath: 'eventid' })`
5. Cleans up old localStorage blob keys -- iterate localStorage and remove keys matching: `^(demo_)?viking_attendance_.+_offline$`, `^(demo_)?viking_shared_attendance_.+_offline$`, `^(demo_)?viking_shared_metadata_`. Use try/catch around localStorage cleanup (best-effort).
6. Log: `logger.info('IndexedDB v6 upgrade: attendance stores normalized', { dbName }, LOG_CATEGORIES.DATABASE)`

**Add STORES constant:** Add `SHARED_EVENT_METADATA: 'shared_event_metadata'` to STORES if not already present. Verify STORES.ATTENDANCE and STORES.SHARED_ATTENDANCE exist.

**New static methods on IndexedDBService:**

1. `bulkReplaceAttendanceForEvent(eventId, records)` -- Following Phase 3's cursor-based section-scoped delete pattern:
   - Open readwrite transaction on STORES.ATTENDANCE
   - Get index on 'eventid', open cursor for String(eventId)
   - Delete all matching records via cursor iteration
   - Put all new records with `updated_at: Date.now()` timestamp
   - await tx.done
   - Full try/catch with logger.error + sentryUtils.captureException (operation: 'indexeddb_bulk_replace_attendance_for_event')
   - Return records.length

2. `getAttendanceByEvent(eventId)` -- `db.getAllFromIndex(STORES.ATTENDANCE, 'eventid', String(eventId))` with empty array fallback. Standard error handling.

3. `getAttendanceByScout(scoutId)` -- `db.getAllFromIndex(STORES.ATTENDANCE, 'scoutid', Number(scoutId))` with empty array fallback. Standard error handling.

4. `getAttendanceRecord(eventId, scoutId)` -- `db.get(STORES.ATTENDANCE, [String(eventId), Number(scoutId)])` with null fallback. Standard error handling.

5. `saveSharedEventMetadata(metadata)` -- `db.put('shared_event_metadata', { ...metadata, updated_at: Date.now() })`. Standard error handling.

6. `getSharedEventMetadata(eventId)` -- `db.get('shared_event_metadata', String(eventId))` with null fallback. Standard error handling.

7. `getAllSharedEventMetadata()` -- `db.getAll('shared_event_metadata')` with empty array fallback. Standard error handling.

All methods follow the exact error handling pattern from Phase 3: try/catch → logger.error with LOG_CATEGORIES.ERROR + context → sentryUtils.captureException with operation tags → rethrow for CRUD, return fallback for queries.

Type coercion in all methods: eventId always String(eventId), scoutId always Number(scoutId) -- matching the Zod schema transforms.
  </action>
  <verify>
Run `npm run lint` from the project directory. No new lint errors. Verify the v6 upgrade block appears after the v5 block. Verify DATABASE_VERSION is 6. Verify all 7 new static methods exist with JSDoc. Verify STORES.SHARED_EVENT_METADATA constant exists.
  </verify>
  <done>
DATABASE_VERSION is 6. v6 upgrade block replaces attendance store with compound keyPath [eventid, scoutid] and 3 indexes, deletes shared_attendance store, creates shared_event_metadata store, cleans up old localStorage blob keys. Seven new IndexedDBService static methods provide full attendance CRUD with compound key access and shared event metadata management.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with no new errors in modified files
2. DATABASE_VERSION is 6 in indexedDBService.js
3. AttendanceSchema in validation.js has only core fields (scoutid, eventid, sectionid, attending, patrol, notes) with passthrough and attending normalization
4. SharedEventMetadataSchema exists in validation.js
5. NORMALIZED_STORES in indexedDBSchema.js has attendance with compound key and shared_event_metadata
6. sqliteSchema.js has shared_event_metadata CREATE TABLE
7. indexedDBService.js has 7 new static methods: bulkReplaceAttendanceForEvent, getAttendanceByEvent, getAttendanceByScout, getAttendanceRecord, saveSharedEventMetadata, getSharedEventMetadata, getAllSharedEventMetadata
</verification>

<success_criteria>
All attendance Zod schemas defined with core-fields-only + passthrough. IndexedDB v6 upgrade creates compound-key attendance store, shared_event_metadata store, and cleans up old blob keys. All CRUD methods available for the DatabaseService layer to consume.
</success_criteria>

<output>
After completion, create `.planning/phases/04-attendance-normalization/04-01-SUMMARY.md`
</output>
