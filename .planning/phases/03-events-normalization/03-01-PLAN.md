---
phase: 03-events-normalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/services/storage/indexedDBService.js
autonomous: true

must_haves:
  truths:
    - "Events store uses keyPath 'eventid' with indexes on sectionid, termid, and startdate after v5 upgrade"
    - "bulkReplaceEventsForSection deletes only events for the target sectionId via index cursor, then inserts new events atomically"
    - "getEventsBySection, getEventsByTerm, and getEventById return correct results from IndexedDB indexes"
  artifacts:
    - path: "src/shared/services/storage/indexedDBService.js"
      provides: "Events store migration in v5 block, bulkReplaceEventsForSection, getEventsBySection, getEventsByTerm, getEventById"
      contains: "bulkReplaceEventsForSection"
  key_links:
    - from: "indexedDBService.js v5 upgrade block"
      to: "STORES.EVENTS"
      via: "deleteObjectStore + createObjectStore with keyPath eventid"
      pattern: "createObjectStore.*STORES\\.EVENTS.*eventid"
    - from: "bulkReplaceEventsForSection"
      to: "sectionid index"
      via: "index.openCursor for scoped delete"
      pattern: "index\\.openCursor"
---

<objective>
Add events store normalization to IndexedDB: migrate the store schema in the v5 upgrade block and add CRUD methods for section-scoped bulk replace and index-based queries.

Purpose: Provides the IndexedDB foundation that DatabaseService (plan 03-02) will call for normalized event storage.
Output: IndexedDBService with bulkReplaceEventsForSection, getEventsBySection, getEventsByTerm, getEventById methods.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sections-normalization/02-01-SUMMARY.md
@src/shared/services/storage/indexedDBService.js
@src/shared/services/storage/schemas/indexedDBSchema.js
@src/shared/services/storage/schemas/validation.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Events store migration in v5 upgrade block</name>
  <files>src/shared/services/storage/indexedDBService.js</files>
  <action>
Inside the existing `if (oldVersion < 5)` block (around line 124), ADD the events store replacement AFTER the existing sections store replacement code. Follow the exact pattern from Phase 2 sections migration:

1. Delete the old events store if it exists: `if (db.objectStoreNames.contains(STORES.EVENTS)) { db.deleteObjectStore(STORES.EVENTS); }`
2. Create new store: `const eventsStore = db.createObjectStore(STORES.EVENTS, { keyPath: 'eventid' });`
3. Create three indexes:
   - `eventsStore.createIndex('sectionid', 'sectionid', { unique: false });`
   - `eventsStore.createIndex('termid', 'termid', { unique: false });`
   - `eventsStore.createIndex('startdate', 'startdate', { unique: false });`
4. Add a logger.info call: `logger.info('IndexedDB v5 upgrade: events store normalized', { dbName }, LOG_CATEGORIES.DATABASE);`

Reference `NORMALIZED_STORES.events` from `schemas/indexedDBSchema.js` for the target schema definition. Leave the original events store creation guard (lines 94-97) in place -- it creates the old-format store for fresh installs, then the v5 block immediately replaces it. This is the same intentionally-redundant pattern used for sections in Phase 2.
  </action>
  <verify>Run `npm run test:run` from the project root. All existing tests must pass (including objectStoreVerification tests). The v5 upgrade block should now contain both sections AND events store replacement.</verify>
  <done>The v5 upgrade block replaces the events store with keyPath 'eventid' and indexes on sectionid, termid, startdate.</done>
</task>

<task type="auto">
  <name>Task 2: Add bulkReplaceEventsForSection and query methods to IndexedDBService</name>
  <files>src/shared/services/storage/indexedDBService.js</files>
  <action>
Add four new static methods to IndexedDBService, placed after the existing `getAllSections()` method (around line 490). Follow the exact error handling pattern used by `bulkReplaceSections` (logger.error + sentryUtils.captureException with operation tags and platform context). Add JSDoc to all methods (no inline comments).

**Method 1: `bulkReplaceEventsForSection(sectionId, events)`**
- Open a readwrite transaction on STORES.EVENTS
- Get the `sectionid` index from the store
- Open a cursor on that index with the sectionId value
- Loop: `while (cursor) { await cursor.delete(); cursor = await cursor.continue(); }`
- Then loop through events: `for (const event of events) { await store.put({ ...event, updated_at: Date.now() }); }`
- Await `tx.done`
- Return `events.length`
- Error handling: logger.error with sectionId, count, error.message, stack; sentryUtils.captureException with operation tag `indexeddb_bulk_replace_events_for_section` and context including sectionId, count, operation name. Re-throw the error.

**IMPORTANT:** This uses index cursor delete (NOT store.clear()) because events are scoped per-section. store.clear() would delete ALL sections' events. The cursor only deletes records matching the target sectionId.

**Method 2: `getEventsBySection(sectionId)`**
- `const db = await getDB();`
- `return (await db.getAllFromIndex(STORES.EVENTS, 'sectionid', sectionId)) || [];`
- Error handling matching getAllSections pattern with operation `indexeddb_get_events_by_section`.

**Method 3: `getEventsByTerm(termId)`**
- `const db = await getDB();`
- `return (await db.getAllFromIndex(STORES.EVENTS, 'termid', termId)) || [];`
- Error handling with operation `indexeddb_get_events_by_term`.

**Method 4: `getEventById(eventId)`**
- `const db = await getDB();`
- `return (await db.get(STORES.EVENTS, eventId)) || null;`
- Error handling with operation `indexeddb_get_event_by_id`.
  </action>
  <verify>Run `npm run test:run`. All tests pass. Run `npm run lint` to verify no lint errors. Grep for `bulkReplaceEventsForSection` in indexedDBService.js to confirm the method exists.</verify>
  <done>IndexedDBService has four new static methods: bulkReplaceEventsForSection (cursor-based section-scoped delete + insert), getEventsBySection, getEventsByTerm, getEventById. All follow established error handling patterns.</done>
</task>

</tasks>

<verification>
1. `npm run test:run` -- all existing tests pass (no regressions)
2. `npm run lint` -- no lint errors
3. grep confirms `bulkReplaceEventsForSection`, `getEventsBySection`, `getEventsByTerm`, `getEventById` exist in indexedDBService.js
4. The v5 upgrade block contains events store replacement with `keyPath: 'eventid'` and three indexes
</verification>

<success_criteria>
IndexedDBService has events store migration in the v5 block and four new CRUD methods for normalized event access. All existing tests continue to pass.
</success_criteria>

<output>
After completion, create `.planning/phases/03-events-normalization/03-01-SUMMARY.md`
</output>
