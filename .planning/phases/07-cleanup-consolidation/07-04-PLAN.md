---
phase: 07-cleanup-consolidation
plan: 04
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - src/shared/services/data/attendanceDataService.js
  - src/shared/utils/cacheCleanup.js
  - src/shared/services/data/__tests__/attendanceDataService.test.js
  - src/scripts/addTestData.js
  - src/shared/utils/__tests__/eventDashboardHelpers.test.js
autonomous: true

must_haves:
  truths:
    - "attendanceDataService.js has no getCachedEvents localStorage scan"
    - "cacheCleanup.js handles IndexedDB store cleanup for non-demo data"
    - "attendanceDataService.test.js does not set viking_*_offline keys in localStorage"
    - "eventDashboardHelpers.test.js mocks match the new non-UnifiedStorageService imports"
    - "addTestData.js is updated or removed"
  artifacts:
    - path: "src/shared/services/data/attendanceDataService.js"
      provides: "Clean attendance service with no legacy localStorage scan"
    - path: "src/shared/utils/cacheCleanup.js"
      provides: "Cache cleanup handling both localStorage demo keys and IndexedDB normalized stores"
    - path: "src/shared/services/data/__tests__/attendanceDataService.test.js"
      provides: "Updated test using IndexedDB mocks instead of localStorage viking_* keys"
    - path: "src/shared/utils/__tests__/eventDashboardHelpers.test.js"
      provides: "Updated test mocking DatabaseService instead of UnifiedStorageService"
  key_links:
    - from: "src/shared/utils/cacheCleanup.js"
      to: "IndexedDBService"
      via: "clear stores for cleanup"
      pattern: "IndexedDBService\\.clear"
---

<objective>
Clean up attendanceDataService legacy localStorage scan, update cacheCleanup for IndexedDB, and fix test files to match new storage patterns.

Purpose: These files contain remnants of the old localStorage-based storage pattern: a legacy getCachedEvents function that scans localStorage, a cacheCleanup utility that only knows about localStorage keys, tests that mock localStorage for viking_* keys, and a dev test data script that writes directly to localStorage.

Output: All files updated to work with normalized IndexedDB stores. Tests mock the correct services. No viking_*_offline localStorage access remains in non-demo code paths.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cleanup-consolidation/07-RESEARCH.md

@src/shared/services/data/attendanceDataService.js
@src/shared/utils/cacheCleanup.js
@src/shared/services/data/__tests__/attendanceDataService.test.js
@src/shared/utils/__tests__/eventDashboardHelpers.test.js
@src/scripts/addTestData.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove getCachedEvents legacy scan and update cacheCleanup.js</name>
  <files>src/shared/services/data/attendanceDataService.js, src/shared/utils/cacheCleanup.js</files>
  <action>
**attendanceDataService.js:**
- Find and remove the `getCachedEvents()` function that scans localStorage for `viking_events_*_offline` keys
- If any callers of getCachedEvents exist, they should use `databaseService.getEvents(sectionId)` instead -- check with `grep -rn "getCachedEvents" src/`
- Remove any other localStorage.getItem/setItem calls for `viking_*_offline` keys in this file
- Keep all other functions that already use DatabaseService (these were updated in Phase 4)

**cacheCleanup.js:**
- The file currently scans localStorage for `viking_events_*`, `viking_attendance_*`, `viking_shared_*` patterns
- Update `cleanupDemoCache()` or equivalent function to:
  - KEEP: localStorage cleanup for `demo_viking_*` keys (demo data lives in localStorage)
  - ADD: IndexedDB store clearing for non-demo normalized data if that is the function's purpose
  - Import IndexedDBService and use `IndexedDBService.clear(storeName)` for each normalized store
  - OR if the function is specifically for demo cache cleanup, keep it localStorage-only (demo data = localStorage)
- Remove any references to non-demo `viking_*_offline` localStorage keys since that data now lives in IndexedDB
- If the function's purpose is cleanup on logout or data clear, it should delegate to `IndexedDBService.clear()` for each store
  </action>
  <verify>
Run `grep -rn "getCachedEvents" src/` -- either zero results or only the updated replacement.
Run `grep -n "viking_events_.*_offline\|viking_attendance_.*_offline\|viking_shared_.*_offline" src/shared/services/data/attendanceDataService.js src/shared/utils/cacheCleanup.js` -- only demo_viking_* patterns should remain.
Run `npm run lint -- --no-warn-ignored src/shared/services/data/attendanceDataService.js src/shared/utils/cacheCleanup.js` -- no errors.
  </verify>
  <done>getCachedEvents legacy localStorage scan removed from attendanceDataService.js. cacheCleanup.js updated to handle IndexedDB stores for non-demo data and localStorage for demo data.</done>
</task>

<task type="auto">
  <name>Task 2: Update test files and addTestData.js</name>
  <files>src/shared/services/data/__tests__/attendanceDataService.test.js, src/shared/utils/__tests__/eventDashboardHelpers.test.js, src/scripts/addTestData.js</files>
  <action>
**attendanceDataService.test.js:**
- Remove any `localStorage.setItem('viking_events_*_offline', ...)` calls in test setup
- Replace with mocks of DatabaseService or IndexedDBService methods that the updated attendanceDataService now calls
- If tests were testing getCachedEvents, remove those tests (function is deleted) or replace with tests for the new DatabaseService-based equivalent
- Ensure vi.mock patterns match the new import structure

**eventDashboardHelpers.test.js:**
- Remove any mock of UnifiedStorageService (`vi.mock('...unifiedStorageService.js', ...)`)
- Replace with mock of DatabaseService or whatever the updated eventDashboardHelpers.js now imports
- Update test assertions to match the new function signatures/return shapes if changed

**addTestData.js:**
- This is a dev testing script that writes `viking_*` keys to localStorage
- Either: (a) update it to write test data via DatabaseService/IndexedDBService methods, or (b) remove it entirely if it is no longer useful
- If keeping, replace `localStorage.setItem('viking_sections_offline', ...)` with `await databaseService.saveSections(testData)` etc.
- If the script is only used for manual testing and is hard to convert (needs async/await at top level), consider removing it with a note that test data can be loaded via demo mode
  </action>
  <verify>
Run `grep -rn "viking_.*_offline" src/shared/services/data/__tests__/attendanceDataService.test.js src/shared/utils/__tests__/eventDashboardHelpers.test.js` -- only demo_viking_* should remain (if any).
Run `grep -rn "UnifiedStorageService\|unifiedStorageService" src/shared/services/data/__tests__/ src/shared/utils/__tests__/` -- zero results.
Run `npm run test:run` -- all tests pass.
  </verify>
  <done>Test files mock DatabaseService/IndexedDBService instead of UnifiedStorageService/localStorage. addTestData.js updated or removed. All tests pass.</done>
</task>

</tasks>

<verification>
Run `grep -rn "getCachedEvents" src/` -- zero results or only updated code.
Run `grep -rn "UnifiedStorageService\|unifiedStorageService" src/shared/services/data/__tests__/ src/shared/utils/__tests__/` -- zero results.
Run `npm run lint` -- no new errors in modified files.
Run `npm run test:run` -- all tests pass.
</verification>

<success_criteria>
attendanceDataService has no legacy localStorage scan. cacheCleanup handles IndexedDB. Test files mock correct services. addTestData.js resolved. All tests pass with no UnifiedStorageService references in test mocks.
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-consolidation/07-04-SUMMARY.md`
</output>
