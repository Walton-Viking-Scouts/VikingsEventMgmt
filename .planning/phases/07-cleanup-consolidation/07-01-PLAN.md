---
phase: 07-cleanup-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/auth/services/auth.js
  - src/shared/hooks/useSignInOut.js
  - src/shared/services/api/api/auth.js
autonomous: true

must_haves:
  truths:
    - "auth.js checkForCachedData uses IndexedDB via DatabaseService instead of localStorage scan"
    - "auth.js logout clears IndexedDB stores instead of scanning localStorage for viking_* keys"
    - "auth.js getUserInfo reads from DatabaseService instead of dynamic UnifiedStorageService import"
    - "useSignInOut.js reads startup data and sections from DatabaseService instead of UnifiedStorageService"
    - "api/auth.js reads/writes startup data via DatabaseService instead of UnifiedStorageService"
    - "No import of UnifiedStorageService remains in any of the three files"
  artifacts:
    - path: "src/features/auth/services/auth.js"
      provides: "IndexedDB-based checkForCachedData, logout, getUserInfo"
    - path: "src/shared/hooks/useSignInOut.js"
      provides: "DatabaseService-based startup data and sections reads"
    - path: "src/shared/services/api/api/auth.js"
      provides: "DatabaseService-based startup data reads/writes without UnifiedStorageService"
  key_links:
    - from: "src/features/auth/services/auth.js"
      to: "DatabaseService / IndexedDBService"
      via: "import and method calls"
      pattern: "databaseService\\.(getSections|getEvents)|IndexedDBService\\.clear"
    - from: "src/shared/hooks/useSignInOut.js"
      to: "DatabaseService"
      via: "import and method calls"
      pattern: "databaseService\\.(getSections|getStartupData)"
---

<objective>
Replace all UnifiedStorageService usage in auth and sign-in consumer files with DatabaseService/IndexedDBService calls.

Purpose: These three files form the authentication and session management layer. They must stop using UnifiedStorageService before it can be deleted. auth.js has three critical functions (checkForCachedData, logout, getUserInfo) that scan localStorage for viking_* keys and must be rewritten to use IndexedDB.

Output: Three files with zero UnifiedStorageService imports, using DatabaseService for all data reads/writes. Demo mode paths preserved in localStorage per decision [04-03].
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cleanup-consolidation/07-RESEARCH.md

@src/features/auth/services/auth.js
@src/shared/hooks/useSignInOut.js
@src/shared/services/api/api/auth.js
@src/shared/services/storage/database.js
@src/shared/services/storage/indexedDBService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace UnifiedStorageService in auth.js with IndexedDB-based implementations</name>
  <files>src/features/auth/services/auth.js</files>
  <action>
Replace all UnifiedStorageService usage in auth.js. Three functions need rewriting:

1. **checkForCachedData()**: Currently scans localStorage for `viking_sections_offline` key. Replace with:
   - For demo mode: keep `localStorage.getItem('demo_viking_sections_offline')` (demo stays in localStorage per decision [04-03])
   - For normal mode: use `await databaseService.getSections()` and check `sections && sections.length > 0`
   - Function must become async (callers already expect this or should be updated)

2. **logout()**: Currently clears localStorage keys matching `viking_*` pattern. Replace with:
   - Import IndexedDBService
   - Clear all normalized IndexedDB stores: `await Promise.allSettled(Object.values(IndexedDBService.STORES).map(s => IndexedDBService.clear(s)))`
   - Keep clearing demo localStorage keys if in demo mode
   - Keep clearing sessionStorage auth tokens (those are legitimate)

3. **getUserInfo()**: Currently uses dynamic `import()` of UnifiedStorageService. Replace with:
   - Import databaseService at top of file
   - Read user/startup data via `databaseService` methods or `IndexedDBService.get(IndexedDBService.STORES.CACHE_DATA, 'viking_startup_data')` if no dedicated method exists

Remove the UnifiedStorageService import (static or dynamic). Add imports for databaseService and IndexedDBService as needed.

IMPORTANT: Do NOT remove `demo_viking_*` localStorage paths. Do NOT touch sessionStorage auth token handling. Only replace `viking_*_offline` data storage paths.
  </action>
  <verify>
Run `grep -n "UnifiedStorageService\|unifiedStorageService" src/features/auth/services/auth.js` -- must return no results.
Run `grep -n "databaseService\|IndexedDBService" src/features/auth/services/auth.js` -- must show new imports and usage.
Run `npm run lint -- --no-warn-ignored src/features/auth/services/auth.js` -- no errors.
  </verify>
  <done>auth.js has zero UnifiedStorageService references. checkForCachedData uses DatabaseService.getSections(), logout clears IndexedDB stores, getUserInfo reads from DatabaseService. Demo mode localStorage paths preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Replace UnifiedStorageService in useSignInOut.js and api/auth.js</name>
  <files>src/shared/hooks/useSignInOut.js, src/shared/services/api/api/auth.js</files>
  <action>
**useSignInOut.js:**
- Remove UnifiedStorageService import
- Replace `UnifiedStorageService.get('viking_startup_data_offline')` with reading from IndexedDB cache_data store: `await IndexedDBService.get(IndexedDBService.STORES.CACHE_DATA, 'viking_startup_data')` or a DatabaseService method if one exists
- Replace `UnifiedStorageService.get('viking_sections_offline')` with `await databaseService.getSections()`
- Add imports for databaseService and/or IndexedDBService as needed

**api/auth.js:**
- Remove UnifiedStorageService import
- Replace `UnifiedStorageService.get('viking_startup_data_offline')` reads with IndexedDB cache_data store read
- Replace `UnifiedStorageService.set('viking_startup_data_offline', data)` writes with IndexedDB cache_data store write: `await IndexedDBService.put(IndexedDBService.STORES.CACHE_DATA, { key: 'viking_startup_data', ...data })` or similar
- KEEP demo mode paths (`demo_viking_startup_data_offline`, `demo_viking_user_roles_offline`) that use safeGetItem/safeSetItem -- those stay in localStorage per decision [04-03]
- Add imports for databaseService and/or IndexedDBService as needed

For startup_data: Since this is stored in the CACHE_DATA IndexedDB store (which is in the UNCHANGED_STORES list per research), use IndexedDBService.get/put directly with a consistent key like 'viking_startup_data'.
  </action>
  <verify>
Run `grep -rn "UnifiedStorageService\|unifiedStorageService" src/shared/hooks/useSignInOut.js src/shared/services/api/api/auth.js` -- must return no results.
Run `npm run lint -- --no-warn-ignored src/shared/hooks/useSignInOut.js src/shared/services/api/api/auth.js` -- no errors.
  </verify>
  <done>useSignInOut.js and api/auth.js have zero UnifiedStorageService references. All data reads/writes go through DatabaseService or IndexedDBService. Demo mode localStorage paths preserved.</done>
</task>

</tasks>

<verification>
Run `grep -rn "UnifiedStorageService\|unifiedStorageService" src/features/auth/services/auth.js src/shared/hooks/useSignInOut.js src/shared/services/api/api/auth.js` -- zero results.
Run `npm run lint` -- no new errors in modified files.
Run `npm run test:run` -- all existing tests pass.
</verification>

<success_criteria>
All three auth/sign-in files have zero UnifiedStorageService imports or usage. All data reads/writes use DatabaseService or IndexedDBService. Demo mode localStorage paths are untouched. Lint and tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-consolidation/07-01-SUMMARY.md`
</output>
