---
phase: 07-cleanup-consolidation
plan: 05
type: execute
wave: 3
depends_on: ["07-03", "07-04"]
files_modified:
  - src/shared/services/storage/currentActiveTermsSchema.md
  - src/shared/services/storage/IMPLEMENTATION_SUMMARY.md
autonomous: true

must_haves:
  truths:
    - "No code file references viking_*_offline keys (excluding demo_viking_* and indexedDBService.js migration cleanup)"
    - "No code file imports UnifiedStorageService"
    - "No code file uses safeGetItem/safeSetItem for non-demo, non-UI data storage"
    - "Every data type follows single write path: API -> validate -> normalize -> store individual records"
    - "Build succeeds with no errors"
    - "All tests pass"
  artifacts:
    - path: "src/shared/services/storage/unifiedStorageService.js"
      provides: "FILE DOES NOT EXIST -- confirmed deleted"
  key_links:
    - from: "all consumer files"
      to: "DatabaseService or IndexedDBService"
      via: "direct imports"
      pattern: "databaseService\\.|IndexedDBService\\."
---

<objective>
Final verification sweep to confirm all legacy storage code is removed and the codebase meets Phase 7 success criteria.

Purpose: This is the final validation that all Phase 7 requirements (CLNP-01 through CLNP-05, XCUT-02, XCUT-03) are satisfied. Grep for any remaining legacy patterns, fix any stragglers, update documentation, run full test suite, and verify build.

Output: Clean codebase with zero legacy blob storage references. Documentation updated. All tests and build passing.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cleanup-consolidation/07-RESEARCH.md

# Need all prior summaries to know what was done
@.planning/phases/07-cleanup-consolidation/07-01-SUMMARY.md
@.planning/phases/07-cleanup-consolidation/07-02-SUMMARY.md
@.planning/phases/07-cleanup-consolidation/07-03-SUMMARY.md
@.planning/phases/07-cleanup-consolidation/07-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Comprehensive grep sweep and fix any remaining legacy references</name>
  <files>any files found by grep sweep</files>
  <action>
Run the following grep searches and fix any violations found:

1. **UnifiedStorageService references** (CLNP-02):
   `grep -rn "UnifiedStorageService\|unifiedStorageService" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx"`
   Expected: zero results. If any found, remove the import and replace usage.

2. **viking_*_offline key references** (CLNP-01):
   `grep -rn "viking_.*_offline" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx"`
   Expected: only `demo_viking_*_offline` patterns (in demoMode.js, demo API paths) and indexedDBService.js migration cleanup regex. Fix any non-demo, non-migration references.

3. **safeGetItem/safeSetItem for data storage** (CLNP-03):
   `grep -rn "safeGetItem\|safeSetItem" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx"`
   Expected: only demo mode reads (events.js, useSharedAttendance.js, demoMode.js) and potentially UI state. If any data storage usage found (non-demo, non-UI), replace with DatabaseService.

4. **Direct localStorage for data** (CLNP-03):
   `grep -rn "localStorage\.\(getItem\|setItem\|removeItem\)" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx"`
   Expected: only legitimate uses (UI state in AppStateContext, SectionMovementTracker, EventAttendance; demo mode in demoMode.js; auth token handling; draft data in AssignmentInterface; test setup). Any `viking_*_offline` data access must be removed.

5. **Dual-write paths** (CLNP-04):
   Check that no file writes data to BOTH localStorage AND IndexedDB for the same data type. Each data type should have exactly one write path.

For each violation found: fix it following the same patterns established in Plans 01-04 (replace with DatabaseService/IndexedDBService calls, keep demo paths, keep UI state paths).

**Documentation cleanup:**
- Update `src/shared/services/storage/currentActiveTermsSchema.md` to remove UnifiedStorageService references
- Update `src/shared/services/storage/IMPLEMENTATION_SUMMARY.md` to remove UnifiedStorageService references and reflect the normalized architecture
- These are .md files inside src/ that document the storage architecture
  </action>
  <verify>
All 5 grep searches above return only expected (allowed) results.
Run `npm run lint` -- zero errors.
Run `npm run test:run` -- all tests pass.
Run `npm run build` -- build succeeds.
  </verify>
  <done>Zero legacy blob storage references in code files. Zero UnifiedStorageService imports. Zero non-demo localStorage data paths. Every data type has a single write path through DatabaseService. Documentation updated. Lint, tests, and build all pass.</done>
</task>

</tasks>

<verification>
**CLNP-01:** `grep -rn "viking_.*_offline" src/ --include="*.js" --include="*.jsx"` returns only demo_viking_* and migration cleanup patterns.
**CLNP-02:** `grep -rn "UnifiedStorageService" src/ --include="*.js" --include="*.jsx"` returns zero results.
**CLNP-03:** `grep -rn "localStorage" src/ --include="*.js" --include="*.jsx"` returns only UI state, demo mode, auth tokens, and draft data.
**CLNP-04:** No file writes to both localStorage and IndexedDB for same data type.
**CLNP-05:** All consumer files import from DatabaseService or IndexedDBService.
**XCUT-02:** Data flows: API -> validate (Zod) -> normalize -> store individual records.
**XCUT-03:** Query functions return consistent shapes on both platforms.
Run `npm run lint` -- zero errors.
Run `npm run test:run` -- all tests pass.
Run `npm run build` -- build succeeds.
</verification>

<success_criteria>
All Phase 7 requirements met. All 5 CLNP requirements verified by grep. XCUT-02 and XCUT-03 confirmed by architecture review. Full lint, test, and build pass. The codebase has zero legacy blob storage code paths.
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-consolidation/07-05-SUMMARY.md`
</output>
