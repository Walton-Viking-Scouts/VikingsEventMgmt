---
phase: 07-cleanup-consolidation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/features/auth/hooks/useAuth.jsx
  - src/features/events/components/EventDashboard.jsx
  - src/shared/services/data/eventsService.js
  - src/shared/utils/eventDashboardHelpers.js
  - src/features/movements/components/AssignmentInterface.jsx
autonomous: true

must_haves:
  truths:
    - "useAuth.jsx reads/writes lastSync via IndexedDB or DatabaseService, not UnifiedStorageService"
    - "EventDashboard.jsx reads lastSync via IndexedDB or DatabaseService, not UnifiedStorageService"
    - "eventsService.js writes shared metadata via databaseService.saveSharedEventMetadata(), not UnifiedStorageService"
    - "eventDashboardHelpers.js reads shared attendance via DatabaseService, not UnifiedStorageService"
    - "AssignmentInterface.jsx uses localStorage directly for draft data, not UnifiedStorageService"
    - "No import of UnifiedStorageService remains in any of the five files"
  artifacts:
    - path: "src/features/auth/hooks/useAuth.jsx"
      provides: "IndexedDB-based lastSync read/write"
    - path: "src/shared/services/data/eventsService.js"
      provides: "DatabaseService-based shared metadata write"
    - path: "src/shared/utils/eventDashboardHelpers.js"
      provides: "DatabaseService-based shared attendance read"
    - path: "src/features/movements/components/AssignmentInterface.jsx"
      provides: "localStorage-based draft storage (no UnifiedStorageService)"
  key_links:
    - from: "src/shared/services/data/eventsService.js"
      to: "databaseService.saveSharedEventMetadata"
      via: "direct method call"
      pattern: "databaseService\\.saveSharedEventMetadata"
    - from: "src/shared/utils/eventDashboardHelpers.js"
      to: "databaseService.getSharedEventMetadata"
      via: "direct method call"
      pattern: "databaseService\\.getSharedEventMetadata"
---

<objective>
Replace all UnifiedStorageService usage in events, dashboard, and assignment consumer files with DatabaseService/IndexedDBService/localStorage calls.

Purpose: These five files form the events and dashboard layer. They must stop using UnifiedStorageService before it can be deleted. The shared metadata write in eventsService.js is a critical data path (Pitfall 5 from research).

Output: Five files with zero UnifiedStorageService imports. Shared metadata flows through existing DatabaseService methods built in Phase 4. Draft data in AssignmentInterface uses localStorage directly.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cleanup-consolidation/07-RESEARCH.md

@src/features/auth/hooks/useAuth.jsx
@src/features/events/components/EventDashboard.jsx
@src/shared/services/data/eventsService.js
@src/shared/utils/eventDashboardHelpers.js
@src/features/movements/components/AssignmentInterface.jsx
@src/shared/services/storage/database.js
@src/shared/services/storage/indexedDBService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace UnifiedStorageService in useAuth.jsx, EventDashboard.jsx, and eventsService.js</name>
  <files>src/features/auth/hooks/useAuth.jsx, src/features/events/components/EventDashboard.jsx, src/shared/services/data/eventsService.js</files>
  <action>
**useAuth.jsx:**
- Remove UnifiedStorageService import
- Replace `UnifiedStorageService.getLastSync()` with reading from IndexedDB cache_data store: `await IndexedDBService.get(IndexedDBService.STORES.CACHE_DATA, 'viking_last_sync')` -- extract the timestamp value from the stored object
- Replace `UnifiedStorageService.setLastSync(timestamp)` with: `await IndexedDBService.put(IndexedDBService.STORES.CACHE_DATA, { key: 'viking_last_sync', timestamp })`
- Note: The `viking_last_sync_time` key in localStorage (used by AppStateContext for UI display) is separate and should NOT be removed -- it is legitimate UI state per research
- Add import for IndexedDBService

**EventDashboard.jsx:**
- Remove UnifiedStorageService import
- Replace `UnifiedStorageService.getLastSync()` with same IndexedDB pattern as useAuth.jsx
- Add import for IndexedDBService

**eventsService.js:**
- Remove UnifiedStorageService import
- Replace shared metadata write: change `await UnifiedStorageService.set(metadataKey, sharedMetadata)` to `await databaseService.saveSharedEventMetadata(sharedMetadata)` -- this method already exists from Phase 4 and handles the IndexedDB write
- The metadata key construction (`viking_shared_metadata_${eventid}`) is no longer needed since saveSharedEventMetadata uses the normalized store with eventid as keyPath
- Add import for databaseService if not already present
  </action>
  <verify>
Run `grep -rn "UnifiedStorageService\|unifiedStorageService" src/features/auth/hooks/useAuth.jsx src/features/events/components/EventDashboard.jsx src/shared/services/data/eventsService.js` -- must return no results.
Run `npm run lint -- --no-warn-ignored src/features/auth/hooks/useAuth.jsx src/features/events/components/EventDashboard.jsx src/shared/services/data/eventsService.js` -- no errors.
  </verify>
  <done>useAuth.jsx, EventDashboard.jsx, and eventsService.js have zero UnifiedStorageService references. lastSync uses IndexedDB cache_data store. Shared metadata writes use databaseService.saveSharedEventMetadata().</done>
</task>

<task type="auto">
  <name>Task 2: Replace UnifiedStorageService in eventDashboardHelpers.js and AssignmentInterface.jsx</name>
  <files>src/shared/utils/eventDashboardHelpers.js, src/features/movements/components/AssignmentInterface.jsx</files>
  <action>
**eventDashboardHelpers.js:**
- Remove UnifiedStorageService dynamic import (`import('...unifiedStorageService.js')`)
- Replace shared attendance read (`viking_shared_attendance_*` key lookup) with `await databaseService.getSharedEventMetadata(eventId)` or equivalent DatabaseService method from Phase 4
- If the function currently constructs a key like `viking_shared_attendance_${eventId}` and passes it to UnifiedStorageService.get(), replace the entire pattern with the DatabaseService method call
- Add import for databaseService at top of file (static import, not dynamic)

**AssignmentInterface.jsx:**
- Remove UnifiedStorageService import
- Replace `UnifiedStorageService.get(draftKey)` with `localStorage.getItem(draftKey)` and JSON.parse the result
- Replace `UnifiedStorageService.set(draftKey, data)` with `localStorage.setItem(draftKey, JSON.stringify(data))`
- Replace `UnifiedStorageService.remove(draftKey)` with `localStorage.removeItem(draftKey)`
- Draft keys are `assignment_draft_*` (NOT viking_* keys) so localStorage is the correct destination per research recommendation
- Wrap localStorage calls in try-catch for resilience (matching storageUtils safeGetItem pattern)
  </action>
  <verify>
Run `grep -rn "UnifiedStorageService\|unifiedStorageService" src/shared/utils/eventDashboardHelpers.js src/features/movements/components/AssignmentInterface.jsx` -- must return no results.
Run `npm run lint -- --no-warn-ignored src/shared/utils/eventDashboardHelpers.js src/features/movements/components/AssignmentInterface.jsx` -- no errors.
  </verify>
  <done>eventDashboardHelpers.js reads shared attendance via DatabaseService. AssignmentInterface.jsx uses localStorage directly for draft data. Zero UnifiedStorageService references in either file.</done>
</task>

</tasks>

<verification>
Run `grep -rn "UnifiedStorageService\|unifiedStorageService" src/features/auth/hooks/useAuth.jsx src/features/events/components/EventDashboard.jsx src/shared/services/data/eventsService.js src/shared/utils/eventDashboardHelpers.js src/features/movements/components/AssignmentInterface.jsx` -- zero results.
Run `npm run lint` -- no new errors in modified files.
Run `npm run test:run` -- all existing tests pass.
</verification>

<success_criteria>
All five event/dashboard/assignment files have zero UnifiedStorageService imports or usage. Shared metadata flows through DatabaseService methods from Phase 4. Draft data uses localStorage directly. Lint and tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-consolidation/07-02-SUMMARY.md`
</output>
