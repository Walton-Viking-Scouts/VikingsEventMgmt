---
phase: 07-cleanup-consolidation
plan: 03
type: execute
wave: 3
depends_on: ["07-01", "07-02", "07-04"]
files_modified:
  - src/shared/services/storage/unifiedStorageService.js
  - src/shared/services/storage/database.js
  - src/shared/utils/storageUtils.js
  - src/shared/services/api/api/base.js
  - src/features/events/services/flexiRecordService.js
autonomous: true

must_haves:
  truths:
    - "unifiedStorageService.js is deleted from the codebase"
    - "database.js has no _getWebStorageSections, _getWebStorageEvents, or _saveWebStorageEvents methods"
    - "database.js has no import of UnifiedStorageService"
    - "safeCacheWithLogging is removed from storageUtils.js (if unused)"
    - "clearFlexiRecordCaches no-ops in base.js and flexiRecordService.js are either removed or implemented properly"
  artifacts:
    - path: "src/shared/services/storage/unifiedStorageService.js"
      provides: "FILE DELETED -- no longer exists"
    - path: "src/shared/services/storage/database.js"
      provides: "Clean DatabaseService with no legacy web-storage methods"
    - path: "src/shared/utils/storageUtils.js"
      provides: "Only session and demo-related safe* functions remain"
  key_links:
    - from: "src/shared/services/storage/database.js"
      to: "IndexedDBService"
      via: "direct import (no UnifiedStorageService intermediary)"
      pattern: "import.*IndexedDBService"
---

<objective>
Delete UnifiedStorageService and remove all legacy web-storage methods from database.js. Clean up storageUtils.js and resolve clearFlexiRecordCaches no-ops.

Purpose: With all consumers migrated in Plans 01 and 02, UnifiedStorageService has zero importers and can be safely deleted. The legacy _getWebStorage* methods in database.js and the safeCacheWithLogging utility are dead code. The clearFlexiRecordCaches no-ops deferred from Phase 6 need final resolution.

Output: UnifiedStorageService file deleted. database.js stripped of legacy methods. storageUtils.js contains only session/demo functions. clearFlexiRecordCaches resolved.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cleanup-consolidation/07-RESEARCH.md

@src/shared/services/storage/unifiedStorageService.js
@src/shared/services/storage/database.js
@src/shared/utils/storageUtils.js
@src/shared/services/api/api/base.js
@src/features/events/services/flexiRecordService.js

# Need summaries from Plans 01 and 02 to confirm all consumers migrated
@.planning/phases/07-cleanup-consolidation/07-01-SUMMARY.md
@.planning/phases/07-cleanup-consolidation/07-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete UnifiedStorageService and remove legacy database.js methods</name>
  <files>src/shared/services/storage/unifiedStorageService.js, src/shared/services/storage/database.js</files>
  <action>
**Delete unifiedStorageService.js:**
- Delete the entire file `src/shared/services/storage/unifiedStorageService.js`
- Verify no remaining imports anywhere: `grep -rn "unifiedStorageService" src/` should only show documentation files

**Clean up database.js:**
- Remove the import of UnifiedStorageService (if any remains)
- Delete `_getWebStorageSections()` method entirely -- getSections() already has the IndexedDB path from Phase 2
- Delete `_getWebStorageEvents()` method entirely -- getEvents() already has the IndexedDB path from Phase 3
- Delete `_saveWebStorageEvents()` method entirely -- saveEvents() already has the IndexedDB path from Phase 3
- If getSections/getEvents/saveEvents have conditional paths that call these _getWebStorage* methods, remove those conditional branches, keeping only the IndexedDB/SQLite paths
- Ensure no other methods in database.js reference UnifiedStorageService

IMPORTANT: Do NOT remove any methods that are called by consumers (getSections, getEvents, saveEvents, etc.). Only remove the internal _getWebStorage* helper methods and their call sites within the public methods.
  </action>
  <verify>
Run `ls src/shared/services/storage/unifiedStorageService.js 2>&1` -- must show "No such file or directory".
Run `grep -rn "UnifiedStorageService\|unifiedStorageService" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx"` -- must return no results (excluding .md documentation files).
Run `grep -n "_getWebStorage" src/shared/services/storage/database.js` -- must return no results.
Run `npm run lint -- --no-warn-ignored src/shared/services/storage/database.js` -- no errors.
  </verify>
  <done>unifiedStorageService.js deleted. database.js has no _getWebStorage* methods and no UnifiedStorageService import. All public DatabaseService methods still work via IndexedDB/SQLite paths.</done>
</task>

<task type="auto">
  <name>Task 2: Clean up storageUtils.js and resolve clearFlexiRecordCaches no-ops</name>
  <files>src/shared/utils/storageUtils.js, src/shared/services/api/api/base.js, src/features/events/services/flexiRecordService.js</files>
  <action>
**storageUtils.js:**
- Check if `safeCacheWithLogging` is still used anywhere: `grep -rn "safeCacheWithLogging" src/`
- If unused: remove the function entirely
- KEEP `safeGetItem` and `safeSetItem` -- these are used by demo mode (demoMode.js, events.js, useSharedAttendance.js) and are legitimate
- KEEP `safeGetSessionItem` and `safeSetSessionItem` -- these are used for auth token storage
- If the module exports are named exports, update the export list to remove deleted functions

**base.js clearFlexiRecordCaches:**
- The no-op was deferred from Phase 6 (decision [06-04])
- Since normalized stores handle their own lifecycle (stores are cleared per-section on sync, per-store on logout via IndexedDB.clear()), this function should be removed entirely OR kept as a no-op that returns empty result
- If callers exist that check the return value, keep as no-op returning `{ clearedLocalStorageKeys: 0 }`
- If no callers depend on the return value, remove the function and update callers to not call it
- Check callers: `grep -rn "clearFlexiRecordCaches" src/`

**flexiRecordService.js clearFlexiRecordCaches:**
- Same analysis as base.js -- check if callers exist and what they expect
- If the function is only called from base.js (or vice versa), consolidate to one location or remove both
- Remove the function if no external callers depend on it, or keep as no-op if callers exist
  </action>
  <verify>
Run `grep -rn "safeCacheWithLogging" src/` -- if removed, must return no results.
Run `npm run lint -- --no-warn-ignored src/shared/utils/storageUtils.js src/shared/services/api/api/base.js src/features/events/services/flexiRecordService.js` -- no errors.
Run `npm run test:run` -- all tests pass.
  </verify>
  <done>storageUtils.js contains only session and demo-safe functions. clearFlexiRecordCaches resolved (removed or properly implemented). No dead code remains in these files.</done>
</task>

</tasks>

<verification>
Run `ls src/shared/services/storage/unifiedStorageService.js 2>&1` -- file does not exist.
Run `grep -rn "UnifiedStorageService\|unifiedStorageService" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx"` -- zero results.
Run `grep -n "_getWebStorage" src/shared/services/storage/database.js` -- zero results.
Run `npm run lint` -- no new errors.
Run `npm run test:run` -- all tests pass.
</verification>

<success_criteria>
UnifiedStorageService is deleted. database.js has no legacy web-storage methods. storageUtils.js is clean. clearFlexiRecordCaches is resolved. No code file references UnifiedStorageService. Lint and tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/07-cleanup-consolidation/07-03-SUMMARY.md`
</output>
