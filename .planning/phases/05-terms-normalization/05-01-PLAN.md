---
phase: 05-terms-normalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/services/storage/indexedDBService.js
  - src/shared/services/storage/schemas/validation.js
autonomous: true

must_haves:
  truths:
    - "Terms store uses keyPath 'termid' with indexes on sectionid and startdate"
    - "TermSchema.sectionid uses .transform(Number) for canonical type coercion"
    - "bulkReplaceTermsForSection atomically replaces all terms for a given section"
    - "Query methods getTermsBySection, getTermById, getAllTerms return correct results"
  artifacts:
    - path: "src/shared/services/storage/indexedDBService.js"
      provides: "v7 upgrade block, bulkReplaceTermsForSection, getTermsBySection, getTermById, getAllTerms"
      contains: "oldVersion < 7"
    - path: "src/shared/services/storage/schemas/validation.js"
      provides: "Updated TermSchema with required sectionid and Number transform"
      contains: "transform(Number)"
  key_links:
    - from: "indexedDBService.js v7 upgrade"
      to: "STORES.TERMS"
      via: "deleteObjectStore + createObjectStore with keyPath 'termid'"
      pattern: "createObjectStore.*STORES\\.TERMS.*termid"
    - from: "bulkReplaceTermsForSection"
      to: "sectionid index"
      via: "cursor-based section-scoped delete then put"
      pattern: "index\\('sectionid'\\)"
---

<objective>
Add IndexedDB v7 upgrade for normalized terms store and CRUD methods. Fix TermSchema sectionid to use .transform(Number).

Purpose: Provides the storage layer for normalized terms -- the same pattern used by events (Phase 3) with cursor-based section-scoped replacement.
Output: Working IndexedDB terms store with keyPath 'termid', indexes on sectionid and startdate, and four static methods on IndexedDBService.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-terms-normalization/05-RESEARCH.md
@src/shared/services/storage/indexedDBService.js
@src/shared/services/storage/schemas/validation.js
@src/shared/services/storage/schemas/indexedDBSchema.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: TermSchema fix and IndexedDB v7 upgrade</name>
  <files>
    src/shared/services/storage/schemas/validation.js
    src/shared/services/storage/indexedDBService.js
  </files>
  <action>
**validation.js:** Update TermSchema sectionid field from `z.union([z.string(), z.number()]).optional()` to `z.union([z.string(), z.number()]).transform(Number)` -- making it required (not optional) with Number coercion. This matches the pattern established for sectionid in SectionSchema and EventSchema. The field is always injected at the write boundary before validation, so making it required catches bugs where injection was missed.

**indexedDBService.js:**
1. Bump DATABASE_VERSION from 6 to 7.
2. Add a new `if (oldVersion < 7)` upgrade block inside the `openDB` upgrade callback. The block must:
   - Delete the existing STORES.TERMS store if it exists: `if (db.objectStoreNames.contains(STORES.TERMS)) { db.deleteObjectStore(STORES.TERMS); }`
   - Create a new terms store: `db.createObjectStore(STORES.TERMS, { keyPath: 'termid' })`
   - Create index 'sectionid': `termsStore.createIndex('sectionid', 'sectionid', { unique: false })`
   - Create index 'startdate': `termsStore.createIndex('startdate', 'startdate', { unique: false })`
   - Log: `logger.info('IndexedDB v7 upgrade: terms store normalized', { dbName }, LOG_CATEGORIES.DATABASE)`
3. Place the v7 block AFTER the existing v6 block, following the established version guard ordering.
  </action>
  <verify>
Grep indexedDBService.js for `DATABASE_VERSION` -- must show 7. Grep for `oldVersion < 7` -- must exist. Grep validation.js for `sectionid` -- must show `.transform(Number)` without `.optional()`. Run `npm run lint` on both files.
  </verify>
  <done>DATABASE_VERSION is 7. The v7 upgrade block deletes old terms store and creates new one with keyPath 'termid' and indexes on sectionid and startdate. TermSchema.sectionid is required with Number transform.</done>
</task>

<task type="auto">
  <name>Task 2: IndexedDB terms CRUD methods</name>
  <files>
    src/shared/services/storage/indexedDBService.js
  </files>
  <action>
Add four static async methods to the IndexedDBService class, following the exact patterns established in Phase 3 (events):

**bulkReplaceTermsForSection(sectionId, terms):**
- Open readwrite transaction on STORES.TERMS
- Get index 'sectionid' from store
- Open cursor on index with sectionId value, delete all matching records via cursor loop
- Put each term from the `terms` array with `{ ...term, updated_at: Date.now() }`
- Await tx.done
- Return terms.length
- Wrap in try/catch: on error, log with logger.error and sentryUtils.captureException using operation tag 'bulkReplaceTermsForSection', then rethrow

**getTermsBySection(sectionId):**
- Call `const db = await getDB()`
- Return `await db.getAllFromIndex(STORES.TERMS, 'sectionid', sectionId)` wrapped in try/catch
- On error: log, capture to Sentry, return empty array (read-path resilience)

**getTermById(termId):**
- Call `const db = await getDB()`
- Return `await db.get(STORES.TERMS, termId)` wrapped in try/catch
- On error: log, capture to Sentry, return null

**getAllTerms():**
- Call `const db = await getDB()`
- Return `await db.getAll(STORES.TERMS)` wrapped in try/catch
- On error: log, capture to Sentry, return empty array

Add JSDoc to all four methods. Do NOT add inline comments.
  </action>
  <verify>
Grep indexedDBService.js for each method name -- all four must exist. Run `npm run lint` to verify no ESLint issues. Run `npm run test:run` to verify no regressions.
  </verify>
  <done>Four static methods exist on IndexedDBService: bulkReplaceTermsForSection (cursor-based section-scoped delete + put), getTermsBySection (index query), getTermById (direct lookup), getAllTerms (full scan). All follow established error handling patterns.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with no new errors
2. `npm run test:run` passes with no regressions
3. DATABASE_VERSION = 7 in indexedDBService.js
4. `if (oldVersion < 7)` block exists with store deletion, recreation, and two indexes
5. TermSchema.sectionid uses `.transform(Number)` (not optional)
6. All four CRUD methods exist with proper error handling
</verification>

<success_criteria>
IndexedDB terms store is migrated to normalized format with keyPath 'termid' and indexes on sectionid and startdate. Four CRUD methods exist for terms storage and retrieval. TermSchema validates sectionid as a required Number field.
</success_criteria>

<output>
After completion, create `.planning/phases/05-terms-normalization/05-01-SUMMARY.md`
</output>
