---
phase: 06-flexi-records-normalization
plan: 04
type: execute
wave: 4
depends_on: ["06-03"]
files_modified:
  - src/features/events/services/flexiRecordService.js
  - src/shared/services/api/api/flexiRecords.js
  - src/features/events/services/campGroupAllocationService.js
autonomous: true

must_haves:
  truths:
    - "flexiRecordService.js reads and writes flexi data through FlexiRecordDataService or DatabaseService -- not UnifiedStorageService"
    - "flexiRecords.js API layer caches responses through DatabaseService -- not UnifiedStorageService"
    - "campGroupAllocationService.js reads flexi data through service calls -- not localStorage key construction"
    - "No viking_flexi_* key string construction remains in these three files"
  artifacts:
    - path: "src/features/events/services/flexiRecordService.js"
      provides: "Feature-layer flexi service using normalized storage"
    - path: "src/shared/services/api/api/flexiRecords.js"
      provides: "API layer caching to normalized storage"
    - path: "src/features/events/services/campGroupAllocationService.js"
      provides: "Camp allocation service using normalized storage"
  key_links:
    - from: "src/features/events/services/flexiRecordService.js"
      to: "src/shared/services/flexiRecordDataService.js"
      via: "service method calls for storage"
      pattern: "flexiRecordDataService|databaseService"
    - from: "src/shared/services/api/api/flexiRecords.js"
      to: "src/shared/services/storage/database.js"
      via: "databaseService calls for caching"
      pattern: "databaseService\\.(save|get)Flexi"
---

<objective>
Migrate the three feature-layer flexi services from UnifiedStorageService/localStorage key-string patterns to the normalized FlexiRecordDataService/DatabaseService API.

Purpose: Eliminates backdoor storage access from the feature layer, ensuring all flexi reads/writes flow through the normalized storage chain.
Output: Three feature-layer files using service calls instead of key-string construction and UnifiedStorageService.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-flexi-records-normalization/06-RESEARCH.md
@.planning/phases/06-flexi-records-normalization/06-03-SUMMARY.md

@src/features/events/services/flexiRecordService.js
@src/shared/services/api/api/flexiRecords.js
@src/features/events/services/campGroupAllocationService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate flexiRecordService.js to normalized storage</name>
  <files>src/features/events/services/flexiRecordService.js</files>
  <action>
This file has extensive `viking_flexi_*` key-string construction and UnifiedStorageService.set/get calls. Replace ALL of them:

**Flexi lists (getFlexiRecordLists, related methods):**
- Replace `UnifiedStorageService.get('viking_flexi_lists_${sectionId}_offline')` with `databaseService.getFlexiLists(sectionId)`
- Replace `UnifiedStorageService.set('viking_flexi_lists_${sectionId}_offline', ...)` with `databaseService.saveFlexiLists(sectionId, lists)`
- Handle demo mode: replace `UnifiedStorageService.get('demo_viking_flexi_lists_...')` with the same `databaseService.getFlexiLists(sectionId)` — demo data will be seeded to the same normalized store (or return empty if not seeded, which is acceptable per NO BACKWARDS COMPAT policy)

**Flexi structures (getFlexiRecordStructure, related methods):**
- Replace `UnifiedStorageService.get('viking_flexi_structure_${recordId}_offline')` with `databaseService.getFlexiStructure(recordId)`
- Replace `UnifiedStorageService.set('viking_flexi_structure_${recordId}_offline', ...)` with `databaseService.saveFlexiStructure(recordId, structure)`
- Handle demo mode variants the same way

**Flexi data (getFlexiRecordData, related methods):**
- Replace `UnifiedStorageService.get('viking_flexi_data_${recordId}_${sectionId}_${termId}_offline')` with `databaseService.getFlexiData(recordId, sectionId, termId)`
- Replace `UnifiedStorageService.set('viking_flexi_data_${recordId}_${sectionId}_${termId}_offline', ...)` with `databaseService.saveFlexiData(recordId, sectionId, termId, data)`

**Cache clearing (clearAllFlexiCache or similar):**
- Replace localStorage key scanning (`Object.keys(localStorage).filter(key => key.includes('viking_flexi_'))`) with appropriate normalized store operations. If the method clears all flexi data, it can call the three stores' clear methods or simply be simplified since the normalized stores handle their own lifecycle.

Import databaseService if not already imported. Remove UnifiedStorageService import if no longer needed.
Remove any `cacheKey` or `storageKey` variable declarations that constructed key strings.
  </action>
  <verify>Run `grep -c "viking_flexi" src/features/events/services/flexiRecordService.js` — should return 0 (or only in comments if any). Run `grep -c "UnifiedStorageService" src/features/events/services/flexiRecordService.js` — should return 0 (unless needed for non-flexi operations). Run `npm run lint` — no errors.</verify>
  <done>flexiRecordService.js uses databaseService for all flexi storage operations. No viking_flexi_ key strings or UnifiedStorageService calls remain.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate flexiRecords.js API layer and campGroupAllocationService.js</name>
  <files>
    src/shared/services/api/api/flexiRecords.js
    src/features/events/services/campGroupAllocationService.js
  </files>
  <action>
**In flexiRecords.js (API layer):**
- Replace all `UnifiedStorageService.set('viking_flexi_lists_${sectionId}_offline', ...)` with `databaseService.saveFlexiLists(sectionId, lists)` or route through FlexiRecordDataService
- Replace all `UnifiedStorageService.get('viking_flexi_lists_${sectionId}_offline')` with `databaseService.getFlexiLists(sectionId)`
- Replace structure storage: `UnifiedStorageService.set('viking_flexi_structure_...')` → `databaseService.saveFlexiStructure(recordId, structure)`
- Replace structure reads: `UnifiedStorageService.get('viking_flexi_structure_...')` → `databaseService.getFlexiStructure(recordId)`
- Handle demo mode key variants the same way (demo data reads from same normalized store)
- Remove all `storageKey` and `cacheKey` variable declarations that constructed key strings
- Import databaseService, remove UnifiedStorageService if no longer needed

**In campGroupAllocationService.js:**
- Replace `viking_flexi_data_${flexirecordid}_${sectionid}_${termid}_offline` cache key construction with `databaseService.getFlexiData(flexirecordid, sectionid, termid)` calls
- There are at least 2 occurrences (lines ~49 and ~443 per grep)
- Remove `UnifiedStorageService.get(cacheKey)` calls and replace with the databaseService call
- Import databaseService if not already imported
  </action>
  <verify>Run `grep -c "viking_flexi" src/shared/services/api/api/flexiRecords.js` — should return 0. Run `grep -c "viking_flexi" src/features/events/services/campGroupAllocationService.js` — should return 0. Run `npm run lint` — no errors. Run `npm run build` — succeeds.</verify>
  <done>Both flexiRecords.js and campGroupAllocationService.js use normalized storage. No key-string construction or UnifiedStorageService flexi calls remain.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. `npm run build` succeeds
3. Zero `viking_flexi_` key-string references in all three files (excluding comments)
4. Zero `UnifiedStorageService` references for flexi operations in all three files
5. All flexi storage goes through databaseService or FlexiRecordDataService
</verification>

<success_criteria>
The three feature-layer services use normalized storage through DatabaseService/FlexiRecordDataService. No backdoor access via UnifiedStorageService or localStorage key construction exists in these files.
</success_criteria>

<output>
After completion, create `.planning/phases/06-flexi-records-normalization/06-04-SUMMARY.md`
</output>
