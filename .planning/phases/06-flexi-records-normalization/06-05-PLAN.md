---
phase: 06-flexi-records-normalization
plan: 05
type: execute
wave: 4
depends_on: ["06-03"]
files_modified:
  - src/features/events/components/CampGroupsView.jsx
  - src/shared/hooks/useSignInOut.js
  - src/features/movements/hooks/useSectionMovements.js
  - src/features/movements/components/SectionMovementTracker.jsx
  - src/features/movements/components/TermMovementCard.jsx
  - src/shared/services/api/api/base.js
autonomous: true

must_haves:
  truths:
    - "CampGroupsView.jsx reads flexi data through service calls -- not localStorage.keys() scanning"
    - "useSignInOut.js reads flexi data through service calls -- not key-string parsing"
    - "Movement components/hooks read flexi data through service calls -- not UnifiedStorageService key construction"
    - "base.js flexi cache clearing is removed or updated to clear normalized stores"
    - "No viking_flexi_ key-string construction remains in any of these 6 files"
  artifacts:
    - path: "src/features/events/components/CampGroupsView.jsx"
      provides: "Component using normalized flexi storage"
    - path: "src/shared/hooks/useSignInOut.js"
      provides: "Hook using normalized flexi storage"
    - path: "src/features/movements/hooks/useSectionMovements.js"
      provides: "Hook using normalized flexi storage"
  key_links:
    - from: "src/features/events/components/CampGroupsView.jsx"
      to: "src/shared/services/storage/database.js"
      via: "databaseService calls"
      pattern: "databaseService\\.(get|save)Flexi"
    - from: "src/shared/hooks/useSignInOut.js"
      to: "src/shared/services/storage/database.js"
      via: "databaseService calls"
      pattern: "databaseService\\.getFlexiData"
---

<objective>
Migrate all component and hook consumers from localStorage/UnifiedStorageService flexi key patterns to the normalized DatabaseService API, and clean up the base.js cache clearing.

Purpose: Eliminates the last backdoor access points for flexi data, ensuring FlexiRecordDataService/DatabaseService is the single source of truth (FLEX-06).
Output: Six files using normalized service calls instead of key-string scanning/parsing.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-flexi-records-normalization/06-RESEARCH.md
@.planning/phases/06-flexi-records-normalization/06-03-SUMMARY.md

@src/features/events/components/CampGroupsView.jsx
@src/shared/hooks/useSignInOut.js
@src/features/movements/hooks/useSectionMovements.js
@src/features/movements/components/SectionMovementTracker.jsx
@src/features/movements/components/TermMovementCard.jsx
@src/shared/services/api/api/base.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate CampGroupsView and useSignInOut</name>
  <files>
    src/features/events/components/CampGroupsView.jsx
    src/shared/hooks/useSignInOut.js
  </files>
  <action>
**CampGroupsView.jsx:**
This component scans `Object.keys(localStorage)` to find flexi structure and data keys, then parses key strings to extract IDs. Replace:

1. Replace the localStorage scanning block that filters for `viking_flexi_structure_` keys (~line 260) with `databaseService.getAllFlexiStructures()` (implemented in Plan 02 Task 1) if iterating over all structures, or `databaseService.getFlexiStructure(recordId)` if querying a specific record. The component currently scans all structures without a specific recordId, so `getAllFlexiStructures()` is the correct replacement.

2. Replace the localStorage scanning block that filters for `viking_flexi_data_` keys (~line 268) with `databaseService.getFlexiData(flexiId, sectionId, termId)` calls. The key-string parsing logic (`viking_flexi_data_FLEXIID_SECTIONID_TERMID_offline`) should be replaced with proper parameter passing.

3. Remove all `Object.keys(localStorage)` calls related to flexi data.

4. Import databaseService. Remove localStorage/UnifiedStorageService imports if no longer needed for other operations in this file.

**useSignInOut.js:**
This hook parses flexi key strings to extract IDs (~line 141): `dataItem.key.replace('viking_flexi_data_', '').replace('_offline', '').split('_')`.

1. Understand what `dataItem` is and where it comes from. The current code discovers termId by scanning key strings. Replace this with `databaseService.getFlexiRecordDataByExtra(extraId)` (implemented in Plan 02 Task 2), which returns all flexi_data rows for a given extraId with explicit fields (extraid, sectionid, termid) — no key-string parsing needed.

2. Replace the key-string parsing with `databaseService.getFlexiRecordDataByExtra(extraId)` calls. The returned rows have structured extraid, sectionid, termid fields directly.

3. Import databaseService if not already imported.
  </action>
  <verify>Run `grep -c "viking_flexi" src/features/events/components/CampGroupsView.jsx` — should return 0. Run `grep -c "viking_flexi" src/shared/hooks/useSignInOut.js` — should return 0. Run `grep -c "Object.keys(localStorage)" src/features/events/components/CampGroupsView.jsx` — should return 0 for flexi-related scanning. Run `npm run lint` — no errors.</verify>
  <done>CampGroupsView and useSignInOut use normalized service calls. No localStorage scanning or key-string parsing for flexi data.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate movement components/hooks and clean up base.js</name>
  <files>
    src/features/movements/hooks/useSectionMovements.js
    src/features/movements/components/SectionMovementTracker.jsx
    src/features/movements/components/TermMovementCard.jsx
    src/shared/services/api/api/base.js
  </files>
  <action>
**useSectionMovements.js:**
- Replace `UnifiedStorageService.get('viking_flexi_lists_${sectionId}_offline')` (~line 66) with `databaseService.getFlexiLists(sectionId)`
- Replace the localStorage key scanning that filters for `viking_flexi_data_${vikingMoversRecord.extraid}_${sectionId}_` (~line 82) with `databaseService.getFlexiRecordDataByExtra(vikingMoversRecord.extraid)` (implemented in Plan 02 Task 2) — this returns all flexi_data rows for the extraId, which can then be filtered by sectionId in-memory. This avoids needing to know termId upfront (the current code discovers termId from key scanning).
- Import databaseService, remove UnifiedStorageService if no longer needed

**SectionMovementTracker.jsx:**
- Replace `UnifiedStorageService.get('viking_flexi_lists_${sectionId}_offline')` (~line 164-166) with `databaseService.getFlexiLists(sectionId)`
- Import databaseService, remove UnifiedStorageService if no longer needed

**TermMovementCard.jsx:**
- Replace `UnifiedStorageService.get('viking_flexi_structure_${firstRecord.flexiRecordId}_offline')` (~line 267) with `databaseService.getFlexiStructure(firstRecord.flexiRecordId)`
- Import databaseService, remove UnifiedStorageService if no longer needed

**base.js (API base):**
- The flexi cache clearing code (~lines 333-339) filters localStorage keys for `viking_flexi_records_`, `viking_flexi_structure_`, and `viking_flexi_consolidated_` patterns
- Since flexi data now lives in IndexedDB/SQLite (not localStorage), either:
  (a) Remove the flexi key filtering entirely from the cache clearing function (these keys no longer exist in localStorage), OR
  (b) Keep the filtering but it will be a no-op since no such keys exist. Prefer option (a) for cleanliness.
- If the clearing function needs to clear normalized flexi stores, that belongs in a different layer (not base.js which handles API caching). Leave that for Phase 7 cleanup.
  </action>
  <verify>Run `grep -rn "viking_flexi" src/features/movements/ src/shared/services/api/api/base.js` — should return 0 matches. Run `npm run lint` — no errors. Run `npm run build` — succeeds.</verify>
  <done>All movement components/hooks use normalized storage. base.js flexi cache clearing is cleaned up. No viking_flexi_ key references remain in any of these files.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. `npm run build` succeeds
3. Zero `viking_flexi_` key-string references across all 6 files
4. Zero `Object.keys(localStorage)` calls for flexi data scanning
5. All flexi reads go through databaseService or FlexiRecordDataService
</verification>

<success_criteria>
All component and hook consumers use normalized storage through DatabaseService. No backdoor access to flexi data via localStorage scanning, key-string parsing, or UnifiedStorageService remains in these files. The FlexiRecordDataService/DatabaseService chain is the single source of truth for flexi data (FLEX-06 satisfied).
</success_criteria>

<output>
After completion, create `.planning/phases/06-flexi-records-normalization/06-05-SUMMARY.md`
</output>
