---
phase: 06-flexi-records-normalization
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/shared/services/flexiRecordDataService.js
  - src/shared/services/data/flexiRecordStructureService.js
autonomous: true

must_haves:
  truths:
    - "FlexiRecordDataService has zero references to storageBackend"
    - "FlexiRecordDataService calls databaseService methods directly for all storage operations"
    - "FlexiRecordDataService has no platform-specific IndexedDB or SQLite code -- all platform branching is in DatabaseService"
    - "Legacy _CACHE_KEYS constants are removed"
  artifacts:
    - path: "src/shared/services/flexiRecordDataService.js"
      provides: "Platform-agnostic flexi data service delegating to DatabaseService"
      contains: "databaseService.saveFlexiLists"
  key_links:
    - from: "src/shared/services/flexiRecordDataService.js"
      to: "src/shared/services/storage/database.js"
      via: "databaseService method calls"
      pattern: "databaseService\\.(save|get)Flexi"
---

<objective>
Migrate FlexiRecordDataService to use DatabaseService instead of phantom storageBackend references, and remove all dead code.

Purpose: Establishes FlexiRecordDataService as a clean intermediary between feature-layer consumers and the normalized storage layer, removing 6 phantom storageBackend references and dead IndexedDB-specific code.
Output: FlexiRecordDataService delegating all storage to DatabaseService with no platform-specific code.
</objective>

<execution_context>
@/Users/simon/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simon/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-flexi-records-normalization/06-RESEARCH.md
@.planning/phases/06-flexi-records-normalization/06-02-SUMMARY.md

@src/shared/services/flexiRecordDataService.js
@src/shared/services/data/flexiRecordStructureService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace storageBackend references with DatabaseService calls</name>
  <files>src/shared/services/flexiRecordDataService.js</files>
  <action>
Replace all 6 `databaseService.storageBackend.*` calls with proper `databaseService.*` method calls:

1. `databaseService.storageBackend.getSections()` → `databaseService.getSections()` (line ~170)
2. `databaseService.storageBackend.saveFlexiRecordData(flexiRecordData)` → `databaseService.saveFlexiData(recordId, sectionId, termId, flexiRecordData)` — extract the three IDs from the data or calling context (line ~262)
3. `databaseService.storageBackend.saveFlexiRecordLists(flexiRecordLists)` → `databaseService.saveFlexiLists(sectionId, flexiRecordLists)` — extract sectionId from calling context (line ~289)
4. `databaseService.storageBackend.saveFlexiRecordStructure(enhancedStructure)` → `databaseService.saveFlexiStructure(recordId, enhancedStructure)` — extract recordId from enhancedStructure.extraid (line ~316)
5. `databaseService.storageBackend.getFlexiRecordLists(sectionIds)` → iterate sectionIds and call `databaseService.getFlexiLists(sectionId)` for each, flatten results (line ~426)
6. `databaseService.storageBackend.getFlexiRecordStructures(flexiRecordIds)` → iterate IDs and call `databaseService.getFlexiStructure(recordId)` for each, filter nulls (line ~440)
7. `databaseService.storageBackend.getFlexiRecordData(flexiRecordIds, sectionIds)` → iterate combinations and call `databaseService.getFlexiData(recordId, sectionId, termId)` for each, collect results (line ~455)

Read the actual code carefully to understand the calling context and parameter availability for each reference. The parameter names in the stub signatures (recordId, sectionId, termId) must match what the caller provides.

If any methods that separately handled IndexedDB vs SQLite paths exist (like `getFlexiRecordListsFromIndexedDB` or similar), replace them with the single `databaseService` call since DatabaseService now handles platform branching.
  </action>
  <verify>Run `grep -c "storageBackend" src/shared/services/flexiRecordDataService.js` — must return 0. Run `npm run lint` — no errors.</verify>
  <done>Zero storageBackend references remain. All storage operations go through databaseService methods.</done>
</task>

<task type="auto">
  <name>Task 2: Remove dead code and update flexiRecordStructureService</name>
  <files>
    src/shared/services/flexiRecordDataService.js
    src/shared/services/data/flexiRecordStructureService.js
  </files>
  <action>
**In flexiRecordDataService.js:**
- Remove the `_CACHE_KEYS` constant object (currently unused dead code)
- Remove any methods that were IndexedDB-specific or SQLite-specific wrappers (e.g., `getFlexiRecordListsFromIndexedDB`, `getFlexiRecordDataFromIndexedDB`, `saveFlexiRecordDataToSQLite`, etc.) — these are replaced by the platform-agnostic DatabaseService calls from Task 1
- Remove any imports that are no longer needed (IndexedDBService, UnifiedStorageService, etc.) after the storageBackend replacement
- Ensure the `databaseService` import exists (should already be imported)
- Update JSDoc on modified methods

**In flexiRecordStructureService.js:**
- Check if it has any direct storage references (UnifiedStorageService, localStorage, storageBackend)
- If so, replace with databaseService calls following the same pattern
- If it already delegates to FlexiRecordDataService or DatabaseService, leave it alone
  </action>
  <verify>Run `npm run lint` — no errors. Run `npm run build` — succeeds. Grep for `_CACHE_KEYS` in flexiRecordDataService.js — should return 0. Grep for `UnifiedStorageService` in flexiRecordDataService.js — should return 0. Grep for `IndexedDBService` in flexiRecordDataService.js — should return 0 (unless legitimately needed for non-flexi operations).</verify>
  <done>FlexiRecordDataService has no dead code, no platform-specific storage references, and delegates entirely to DatabaseService for storage operations.</done>
</task>

</tasks>

<verification>
1. `npm run lint` passes
2. `npm run build` succeeds
3. Zero `storageBackend` references in flexiRecordDataService.js
4. Zero `_CACHE_KEYS` references in flexiRecordDataService.js
5. FlexiRecordDataService imports only databaseService for storage (no IndexedDBService, no UnifiedStorageService)
</verification>

<success_criteria>
FlexiRecordDataService is a clean service layer that delegates all storage operations to DatabaseService. No phantom storageBackend, no dead code, no platform-specific storage references.
</success_criteria>

<output>
After completion, create `.planning/phases/06-flexi-records-normalization/06-03-SUMMARY.md`
</output>
