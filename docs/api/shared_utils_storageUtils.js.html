<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: shared/utils/storageUtils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: shared/utils/storageUtils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Safe storage utilities with structured logging
import { sentryUtils } from '../services/utils/sentry.js';
import logger, { LOG_CATEGORIES } from '../services/utils/logger.js';

/**
 * Safely get and parse an item from localStorage with structured error logging
 * @param {string} key - Storage key to retrieve
 * @param {*} defaultValue - Default value if key doesn't exist or parsing fails
 * @returns {*} Parsed value or default value
 * @example
 * // Get cached user preferences with fallback
 * const preferences = safeGetItem('user_preferences', { theme: 'light' });
 * 
 * // Get array data with empty array fallback
 * const sections = safeGetItem('viking_sections_offline', []);
 */
export function safeGetItem(key, defaultValue = null) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : defaultValue;
  } catch (error) {
    // Log to structured logger with context
    logger.warn('Storage retrieval failed', {
      operation: 'localStorage.getItem',
      key,
      error: error.message,
      hasDefaultValue: defaultValue !== null,
      stack: error.stack,
    }, LOG_CATEGORIES.ERROR);

    // Capture exception with Sentry
    sentryUtils.captureException(error, {
      tags: {
        operation: 'storage_get',
        storage_type: 'localStorage',
      },
      contexts: {
        storage: {
          key,
          hasDefaultValue: defaultValue !== null,
          defaultValueType: typeof defaultValue,
        },
      },
    });

    return defaultValue;
  }
}

/**
 * Safely set an item in localStorage with JSON serialization and structured error logging
 * @param {string} key - Storage key to set
 * @param {*} value - Value to store (will be JSON serialized)
 * @returns {boolean} True if successful, false otherwise
 * @example
 * // Store user preferences
 * const success = safeSetItem('user_preferences', { theme: 'dark', language: 'en' });
 * 
 * // Store array data
 * const success = safeSetItem('viking_sections_offline', sections);
 */
export function safeSetItem(key, value) {
  try {
    // Handle undefined values to prevent storing "undefined" string
    const serializedValue = value === undefined ? 'null' : JSON.stringify(value);
    localStorage.setItem(key, serializedValue);
    return true;
  } catch (error) {
    // Log to structured logger with context
    logger.warn('Storage write failed', {
      operation: 'localStorage.setItem',
      key,
      valueType: typeof value,
      isArray: Array.isArray(value),
      error: error.message,
      stack: error.stack,
    }, LOG_CATEGORIES.ERROR);

    // Capture exception with Sentry
    sentryUtils.captureException(error, {
      tags: {
        operation: 'storage_set',
        storage_type: 'localStorage',
      },
      contexts: {
        storage: {
          key,
          valueType: typeof value,
          isArray: Array.isArray(value),
          estimatedSize: 'N/A (serialization failed)',
        },
      },
    });

    return false;
  }
}

/**
 * Safely get and parse an item from sessionStorage with structured error logging
 * @param {string} key - Storage key to retrieve
 * @param {*} defaultValue - Default value if key doesn't exist or parsing fails
 * @returns {*} Parsed value or default value
 * @example
 * // Get authentication token with fallback
 * const token = safeGetSessionItem('auth_token', null);
 * 
 * // Get temporary state with object fallback
 * const state = safeGetSessionItem('temp_state', { initialized: false });
 */
export function safeGetSessionItem(key, defaultValue = null) {
  try {
    const item = sessionStorage.getItem(key);
    return item ? JSON.parse(item) : defaultValue;
  } catch (error) {
    // Log to structured logger with context
    logger.warn('Session storage retrieval failed', {
      operation: 'sessionStorage.getItem',
      key,
      error: error.message,
      hasDefaultValue: defaultValue !== null,
      stack: error.stack,
    }, LOG_CATEGORIES.ERROR);

    // Capture exception with Sentry
    sentryUtils.captureException(error, {
      tags: {
        operation: 'storage_get',
        storage_type: 'sessionStorage',
      },
      contexts: {
        storage: {
          key,
          hasDefaultValue: defaultValue !== null,
          defaultValueType: typeof defaultValue,
        },
      },
    });

    return defaultValue;
  }
}

/**
 * Safely set an item in sessionStorage with JSON serialization and structured error logging
 * @param {string} key - Storage key to set
 * @param {*} value - Value to store (will be JSON serialized)
 * @returns {boolean} True if successful, false otherwise
 * @example
 * // Store authentication token
 * const success = safeSetSessionItem('auth_token', tokenData);
 * 
 * // Store temporary application state
 * const success = safeSetSessionItem('temp_state', { step: 2, data: formData });
 */
export function safeSetSessionItem(key, value) {
  try {
    // Handle undefined values to prevent storing "undefined" string
    const serializedValue = value === undefined ? 'null' : JSON.stringify(value);
    sessionStorage.setItem(key, serializedValue);
    return true;
  } catch (error) {
    // Log to structured logger with context
    logger.warn('Session storage write failed', {
      operation: 'sessionStorage.setItem',
      key,
      valueType: typeof value,
      isArray: Array.isArray(value),
      error: error.message,
      stack: error.stack,
    }, LOG_CATEGORIES.ERROR);

    // Capture exception with Sentry
    sentryUtils.captureException(error, {
      tags: {
        operation: 'storage_set',
        storage_type: 'sessionStorage',
      },
      contexts: {
        storage: {
          key,
          valueType: typeof value,
          isArray: Array.isArray(value),
          estimatedSize: 'N/A (serialization failed)',
        },
      },
    });

    return false;
  }
}
/**
 * Enhanced caching utility with comprehensive error handling and logging
 * Provides standardized caching pattern to avoid silent failures in production
 * 
 * @param {string} cacheKey - Cache key for localStorage
 * @param {any} data - Data to cache
 * @param {string} category - Log category for structured logging
 * @param {Object} context - Additional context for logging
 * @returns {boolean} Success status of caching operation
 * 
 * @example
 * // Cache API response data
 * const success = safeCacheWithLogging(
 *   'viking_members_offline',
 *   membersData,
 *   LOG_CATEGORIES.API,
 *   { sectionId: '12345', operation: 'sync_members' }
 * );
 */
export async function safeCacheWithLogging(cacheKey, data, category, context = {}) {
  // Dynamic imports to avoid circular dependencies
  const { default: logger, LOG_CATEGORIES } = await import('../services/utils/logger.js');
  const { sentryUtils } = await import('../services/utils/sentry.js');
  
  try {
    // Add timestamp for TTL-based caching
    const cachedData = { 
      ...data, 
      _cacheTimestamp: Date.now(), 
    };
    
    const success = safeSetItem(cacheKey, cachedData);
    
    // Enhanced logging with data insights
    const logContext = {
      cacheKey,
      dataSize: JSON.stringify(cachedData).length,
      itemCount: Array.isArray(data) ? data.length : (data &amp;&amp; typeof data === 'object' ? Object.keys(data).length : 0),
      hasTimestamp: !!data._cacheTimestamp,
      ...context,
    };
    
    if (success) {
      logger.info('Data successfully cached', logContext, category || LOG_CATEGORIES.API);
    } else {
      logger.error('Data caching failed - safeSetItem returned false', logContext, LOG_CATEGORIES.ERROR);
    }
    
    return success;
    
  } catch (error) {
    const errorContext = {
      cacheKey,
      error: error.message,
      errorType: error.name,
      dataType: typeof data,
      isArray: Array.isArray(data),
      ...context,
    };
    
    logger.error('Data caching error - exception thrown', errorContext, LOG_CATEGORIES.ERROR);
    
    sentryUtils.captureException(error, {
      tags: {
        operation: 'safe_cache_with_logging',
        cache_key: cacheKey,
      },
      contexts: {
        caching: errorContext,
      },
    });
    
    return false;
  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-DatabaseService.html">DatabaseService</a></li><li><a href="module-EventCard.html">EventCard</a></li><li><a href="module-FlexiRecordService.html">FlexiRecordService</a></li><li><a href="module-auth.html">auth</a></li><li><a href="module-logger.html">logger</a></li><li><a href="module-notifications.html">notifications</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-logger-logger.html">logger</a></li></ul><h3>Classes</h3><ul><li><a href="APIQueue.html">APIQueue</a></li><li><a href="RateLimitQueue.html">RateLimitQueue</a></li><li><a href="module-DatabaseService-DatabaseService.html">DatabaseService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Alert">Alert</a></li><li><a href="global.html#AuthButton">AuthButton</a></li><li><a href="global.html#CampGroupCard">CampGroupCard</a></li><li><a href="global.html#CampGroupsView">CampGroupsView</a></li><li><a href="global.html#ConfirmModal">ConfirmModal</a></li><li><a href="global.html#DEMO_CACHE_DATA">DEMO_CACHE_DATA</a></li><li><a href="global.html#GroupNamesEditModal">GroupNamesEditModal</a></li><li><a href="global.html#Modal">Modal</a></li><li><a href="global.html#REQUIRED_VIKING_SECTION_MOVERS_FIELDS">REQUIRED_VIKING_SECTION_MOVERS_FIELDS</a></li><li><a href="global.html#SectionFilter">SectionFilter</a></li><li><a href="global.html#_generateProductionFormatAttendance">_generateProductionFormatAttendance</a></li><li><a href="global.html#assignMemberToCampGroupDemo">assignMemberToCampGroupDemo</a></li><li><a href="global.html#batchAssignMembers">batchAssignMembers</a></li><li><a href="global.html#buildEventCard">buildEventCard</a></li><li><a href="global.html#calculateActualAge">calculateActualAge</a></li><li><a href="global.html#calculateAge">calculateAge</a></li><li><a href="global.html#checkForDemoData">checkForDemoData</a></li><li><a href="global.html#checkNetworkStatus">checkNetworkStatus</a></li><li><a href="global.html#cleanupDemoCache">cleanupDemoCache</a></li><li><a href="global.html#clearFlexiRecordCaches">clearFlexiRecordCaches</a></li><li><a href="global.html#cn">cn</a></li><li><a href="global.html#convertSharedEventToAttendanceFormat">convertSharedEventToAttendanceFormat</a></li><li><a href="global.html#demoConfig">demoConfig</a></li><li><a href="global.html#expandSharedEvents">expandSharedEvents</a></li><li><a href="global.html#extractFlexiRecordContext">extractFlexiRecordContext</a></li><li><a href="global.html#extractVikingEventFields">extractVikingEventFields</a></li><li><a href="global.html#fetchAllSectionEvents">fetchAllSectionEvents</a></li><li><a href="global.html#fetchEventAttendance">fetchEventAttendance</a></li><li><a href="global.html#fetchMostRecentTermId">fetchMostRecentTermId</a></li><li><a href="global.html#fetchSectionEvents">fetchSectionEvents</a></li><li><a href="global.html#filterEventsByDateRange">filterEventsByDateRange</a></li><li><a href="global.html#findMemberSectionName">findMemberSectionName</a></li><li><a href="global.html#findMemberSectionType">findMemberSectionType</a></li><li><a href="global.html#generateDemoSharedAttendance">generateDemoSharedAttendance</a></li><li><a href="global.html#generateVikingSectionMoversErrorMessages">generateVikingSectionMoversErrorMessages</a></li><li><a href="global.html#getEventAttendance">getEventAttendance</a></li><li><a href="global.html#getEventSharingStatus">getEventSharingStatus</a></li><li><a href="global.html#getEventSummary">getEventSummary</a></li><li><a href="global.html#getEvents">getEvents</a></li><li><a href="global.html#getFlexiRecords">getFlexiRecords</a></li><li><a href="global.html#getFlexiStructure">getFlexiStructure</a></li><li><a href="global.html#getListOfMembers">getListOfMembers</a></li><li><a href="global.html#getMembersGrid">getMembersGrid</a></li><li><a href="global.html#getMostRecentTermId">getMostRecentTermId</a></li><li><a href="global.html#getSharedEventAttendance">getSharedEventAttendance</a></li><li><a href="global.html#getSingleFlexiRecord">getSingleFlexiRecord</a></li><li><a href="global.html#getStartupData">getStartupData</a></li><li><a href="global.html#getTerms">getTerms</a></li><li><a href="global.html#getUniqueSectionsFromEvents">getUniqueSectionsFromEvents</a></li><li><a href="global.html#getUserAccessibleSections">getUserAccessibleSections</a></li><li><a href="global.html#getUserRoles">getUserRoles</a></li><li><a href="global.html#groupContactInfo">groupContactInfo</a></li><li><a href="global.html#groupEventsByName">groupEventsByName</a></li><li><a href="global.html#handleAPIResponseWithRateLimit">handleAPIResponseWithRateLimit</a></li><li><a href="global.html#initializeDemoMode">initializeDemoMode</a></li><li><a href="global.html#isDemoMode">isDemoMode</a></li><li><a href="global.html#isSharedEventOwner">isSharedEventOwner</a></li><li><a href="global.html#logRateLimitInfo">logRateLimitInfo</a></li><li><a href="global.html#mergeSharedAndSectionAttendance">mergeSharedAndSectionAttendance</a></li><li><a href="global.html#multiUpdateFlexiRecord">multiUpdateFlexiRecord</a></li><li><a href="global.html#organizeByCampGroups">organizeByCampGroups</a></li><li><a href="global.html#organizeMembersByCampGroups">organizeMembersByCampGroups</a></li><li><a href="global.html#parseFlexiStructure">parseFlexiStructure</a></li><li><a href="global.html#parseTimestamp">parseTimestamp</a></li><li><a href="global.html#quickValidateVikingSectionMovers">quickValidateVikingSectionMovers</a></li><li><a href="global.html#retrieveUserInfo">retrieveUserInfo</a></li><li><a href="global.html#safeCacheWithLogging">safeCacheWithLogging</a></li><li><a href="global.html#safeGetItem">safeGetItem</a></li><li><a href="global.html#safeGetSessionItem">safeGetSessionItem</a></li><li><a href="global.html#safeSetItem">safeSetItem</a></li><li><a href="global.html#safeSetSessionItem">safeSetSessionItem</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#sleepWithAbort">sleepWithAbort</a></li><li><a href="global.html#testBackendConnection">testBackendConnection</a></li><li><a href="global.html#transformFlexiRecordData">transformFlexiRecordData</a></li><li><a href="global.html#updateFlexiRecord">updateFlexiRecord</a></li><li><a href="global.html#useAttendanceData">useAttendanceData</a></li><li><a href="global.html#useSignInOut">useSignInOut</a></li><li><a href="global.html#validateMemberMove">validateMemberMove</a></li><li><a href="global.html#validateTokenBeforeAPICall">validateTokenBeforeAPICall</a></li><li><a href="global.html#validateVikingSectionMoversFlexiRecord">validateVikingSectionMoversFlexiRecord</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Sep 10 2025 22:12:57 GMT+0100 (British Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
