<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: shared/utils/cacheCleanup.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: shared/utils/cacheCleanup.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview Cache cleanup utilities for Viking Event Management
 * 
 * This module provides specialized cache cleanup functions to maintain data
 * integrity across different application modes. Prevents demo data contamination
 * in production environments and ensures clean separation between demo and
 * production cached data.
 * 
 * The cleanup system is essential for the offline-first architecture, ensuring
 * that cached data remains consistent and relevant to the current application
 * mode. Demo data cleanup prevents confusion and maintains professional
 * presentation in production Scout environments.
 * 
 * @module cacheCleanup
 * @version 2.3.7
 * @since 2.2.0 - Demo/production separation
 * @author Vikings Event Management Team
 */

import logger, { LOG_CATEGORIES } from '../services/utils/logger.js';
import { isDemoMode } from '../../config/demoMode.js';

/**
 * Cleans up demo cache data when application is not in demo mode
 * 
 * Performs comprehensive cleanup of localStorage to remove demo data that
 * might contaminate production Scout environments. Scans for both explicitly
 * demo-prefixed keys and regular cache keys that contain demo event data.
 * 
 * This function is critical for maintaining data integrity when switching
 * between demo mode (for training and demonstrations) and production mode
 * (for actual Scout events). Demo data includes synthetic events, members,
 * and attendance records that should never appear in real Scout operations.
 * 
 * The cleanup process is safe and selective - it only removes data when
 * NOT in demo mode, preserving demo data when demonstrations are intentional.
 * 
 * @returns {void} No return value - operates by side effect on localStorage
 * 
 * @example
 * // Clean up demo data on production application startup
 * import { cleanupDemoCache } from './cacheCleanup.js';
 * 
 * // During app initialization in production
 * if (!isDemoMode()) {
 *   cleanupDemoCache(); // Removes any leftover demo data
 *   logger.info('Demo cache cleanup completed');
 * }
 * 
 * @example
 * // Integration with application mode switching
 * const switchToProductionMode = () => {
 *   // Update mode configuration
 *   setProductionMode(true);
 *   
 *   // Clean up any demo data from localStorage
 *   cleanupDemoCache();
 *   
 *   // Reload Scout data from OSM
 *   await reloadProductionData();
 * };
 * 
 * @example
 * // Cache keys that would be cleaned up in production
 * // Direct demo keys:
 * localStorage.setItem('demo_viking_events_123', JSON.stringify(demoEvents));
 * localStorage.setItem('demo_event_attendance_456', JSON.stringify(demoAttendance));
 * 
 * // Contaminated regular keys:
 * localStorage.setItem('viking_events_offline', JSON.stringify([
 *   { eventid: 'demo_event_123', sectionname: 'Demo Beavers' }, // Demo event
 *   { eventid: 'real_123', sectionname: '1st Walton Beavers' }   // Real event
 * ]));
 * 
 * // After cleanupDemoCache():
 * // - All demo_* keys removed
 * // - viking_events_offline removed (contained demo data)
 * // - Real-only cache keys remain untouched
 * 
 * @example
 * // Monitor cleanup operation results
 * const beforeKeys = Object.keys(localStorage).length;
 * cleanupDemoCache();
 * const afterKeys = Object.keys(localStorage).length;
 * 
 * if (beforeKeys > afterKeys) {
 *   console.log(`Cleanup removed ${beforeKeys - afterKeys} contaminated cache entries`);
 * } else {
 *   console.log('No demo data found - cache already clean');
 * }
 * 
 * @since 2.2.0
 */
export function cleanupDemoCache() {
  // Only clean up if we're NOT in demo mode
  if (isDemoMode()) {
    return;
  }

  const keysToRemove = [];
  
  // Check all localStorage keys for demo data
  for (let i = 0; i &lt; localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key &amp;&amp; (key.startsWith('demo_') || key.includes('demo_event_'))) {
      keysToRemove.push(key);
    }
  }

  // Also check for any regular cache keys that might contain demo events
  const regularCacheKeys = [];
  for (let i = 0; i &lt; localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key &amp;&amp; (
      key.includes('viking_events_') || 
      key.includes('viking_attendance_') ||
      key.includes('viking_shared_')
    )) {
      try {
        const data = localStorage.getItem(key);
        if (data) {
          const parsed = JSON.parse(data);
          // Check if this cache contains demo events
          const hasDemo = checkForDemoData(parsed);
          if (hasDemo) {
            regularCacheKeys.push(key);
          }
        }
      } catch (error) {
        // Skip non-JSON items
      }
    }
  }

  const totalKeys = keysToRemove.length + regularCacheKeys.length;
  if (totalKeys > 0) {
    // Remove demo-prefixed keys
    keysToRemove.forEach(key => {
      localStorage.removeItem(key);
    });

    // Remove contaminated regular cache keys
    regularCacheKeys.forEach(key => {
      localStorage.removeItem(key);
    });

    logger.info('ðŸ§¹ Cleaned up demo cache data from production', {
      demoPrefixedKeys: keysToRemove.length,
      contaminatedKeys: regularCacheKeys.length,
      totalCleaned: totalKeys,
    }, LOG_CATEGORIES.APP);
  }
}

/**
 * Recursively checks if data structure contains demo events or references
 * 
 * Performs deep inspection of data structures to identify demo content
 * that should not appear in production Scout environments. Checks for
 * demo event IDs, demo section names, and nested demo references.
 * 
 * This function supports the cache cleanup process by accurately identifying
 * contaminated cache entries that mix demo and production data, ensuring
 * complete removal of demo content from production environments.
 * 
 * @param {*} data - Data structure to inspect for demo content
 * @returns {boolean} True if demo content is found, false if data is clean
 * 
 * @example
 * // Check individual event objects
 * const cleanEvent = { eventid: 'evt_123', sectionname: '1st Walton Beavers' };
 * const demoEvent = { eventid: 'demo_event_456', sectionname: 'Demo Scouts' };
 * 
 * console.log(checkForDemoData(cleanEvent)); // false
 * console.log(checkForDemoData(demoEvent));  // true
 * 
 * @example
 * // Check array of mixed data
 * const mixedEvents = [
 *   { eventid: 'real_123', sectionname: '1st Walton Cubs' },
 *   { eventid: 'demo_event_789', sectionname: 'Demo Beavers' },
 *   { eventid: 'real_456', sectionname: '2nd Walton Scouts' }
 * ];
 * 
 * console.log(checkForDemoData(mixedEvents)); // true (contains demo event)
 * 
 * @example
 * // Check nested object structures
 * const nestedData = {
 *   events: {
 *     items: [
 *       { eventid: 'demo_event_123' } // Deep demo reference
 *     ]
 *   },
 *   metadata: { source: 'production' }
 * };
 * 
 * console.log(checkForDemoData(nestedData)); // true (found nested demo)
 * 
 * @example
 * // Check for demo section names
 * const sectionData = { sectionname: 'Demo Beavers Colony' };
 * console.log(checkForDemoData(sectionData)); // true (demo section)
 * 
 * const realSection = { sectionname: '1st Walton Beavers Colony' };
 * console.log(checkForDemoData(realSection)); // false (real section)
 * 
 * @since 2.2.0
 * @private
 */
function checkForDemoData(data) {
  if (!data) return false;

  // Check if data is an array and has demo events
  if (Array.isArray(data)) {
    return data.some((item) => {
      if (typeof item === 'string') return item.includes('demo_event_') || item.startsWith('Demo ');
      if (Array.isArray(item) || (item &amp;&amp; typeof item === 'object')) return checkForDemoData(item);
      const eid = item?.eventid;
      const sectionname = item?.sectionname;
      return (typeof eid === 'string' &amp;&amp; eid.startsWith('demo_event_')) ||
             (typeof sectionname === 'string' &amp;&amp; sectionname.startsWith('Demo '));
    });
  }

  // Check if data has items property with demo events
  if (data.items &amp;&amp; Array.isArray(data.items)) {
    return data.items.some((item) => {
      const eid = item?.eventid;
      return typeof eid === 'string' &amp;&amp; eid.startsWith('demo_event_');
    });
  }

  // Check if data itself has demo eventid
  if (typeof data.eventid === 'string' &amp;&amp; data.eventid.startsWith('demo_event_')) {
    return true;
  }

  // Check if data is a demo section (by sectionname)
  if (typeof data.sectionname === 'string' &amp;&amp; data.sectionname.startsWith('Demo ')) {
    return true;
  }

  // Check nested properties for demo references
  if (typeof data === 'object') {
    for (const value of Object.values(data)) {
      if (typeof value === 'string' &amp;&amp; (value.includes('demo_event_') || value.startsWith('Demo '))) {
        return true;
      }
      if (Array.isArray(value) &amp;&amp; checkForDemoData(value)) {
        return true;
      }
      if (value &amp;&amp; typeof value === 'object' &amp;&amp; checkForDemoData(value)) {
        return true;
      }
    }
  }

  return false;
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-DatabaseService.html">DatabaseService</a></li><li><a href="module-EventCard.html">EventCard</a></li><li><a href="module-FlexiRecordService.html">FlexiRecordService</a></li><li><a href="module-ageUtils.html">ageUtils</a></li><li><a href="module-auth.html">auth</a></li><li><a href="module-cacheCleanup.html">cacheCleanup</a></li><li><a href="module-flexiRecordTransforms.html">flexiRecordTransforms</a></li><li><a href="module-logger.html">logger</a></li><li><a href="module-notifications.html">notifications</a></li><li><a href="module-sectionHelpers.html">sectionHelpers</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-logger-logger.html">logger</a></li></ul><h3>Classes</h3><ul><li><a href="APIQueue.html">APIQueue</a></li><li><a href="ErrorBoundary.html">ErrorBoundary</a></li><li><a href="RateLimitQueue.html">RateLimitQueue</a></li><li><a href="SyncService.html">SyncService</a></li><li><a href="module-DatabaseService-DatabaseService.html">DatabaseService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Alert">Alert</a></li><li><a href="global.html#App">App</a></li><li><a href="global.html#AppContent">AppContent</a></li><li><a href="global.html#AppRouter">AppRouter</a></li><li><a href="global.html#AuthButton">AuthButton</a></li><li><a href="global.html#CampGroupCard">CampGroupCard</a></li><li><a href="global.html#CampGroupsView">CampGroupsView</a></li><li><a href="global.html#ConfirmModal">ConfirmModal</a></li><li><a href="global.html#DEMO_CACHE_DATA">DEMO_CACHE_DATA</a></li><li><a href="global.html#GroupNamesEditModal">GroupNamesEditModal</a></li><li><a href="global.html#Modal">Modal</a></li><li><a href="global.html#REQUIRED_VIKING_SECTION_MOVERS_FIELDS">REQUIRED_VIKING_SECTION_MOVERS_FIELDS</a></li><li><a href="global.html#SectionFilter">SectionFilter</a></li><li><a href="global.html#_generateProductionFormatAttendance">_generateProductionFormatAttendance</a></li><li><a href="global.html#assignMemberToCampGroupDemo">assignMemberToCampGroupDemo</a></li><li><a href="global.html#batchAssignMembers">batchAssignMembers</a></li><li><a href="global.html#buildEventCard">buildEventCard</a></li><li><a href="global.html#checkNetworkStatus">checkNetworkStatus</a></li><li><a href="global.html#clearFlexiRecordCaches">clearFlexiRecordCaches</a></li><li><a href="global.html#cn">cn</a></li><li><a href="global.html#convertSharedEventToAttendanceFormat">convertSharedEventToAttendanceFormat</a></li><li><a href="global.html#demoConfig">demoConfig</a></li><li><a href="global.html#expandSharedEvents">expandSharedEvents</a></li><li><a href="global.html#extractFlexiRecordContext">extractFlexiRecordContext</a></li><li><a href="global.html#fetchAllSectionEvents">fetchAllSectionEvents</a></li><li><a href="global.html#fetchEventAttendance">fetchEventAttendance</a></li><li><a href="global.html#fetchMostRecentTermId">fetchMostRecentTermId</a></li><li><a href="global.html#fetchSectionEvents">fetchSectionEvents</a></li><li><a href="global.html#filterEventsByDateRange">filterEventsByDateRange</a></li><li><a href="global.html#formatPhoneForCall">formatPhoneForCall</a></li><li><a href="global.html#generateDemoSharedAttendance">generateDemoSharedAttendance</a></li><li><a href="global.html#generateVikingSectionMoversErrorMessages">generateVikingSectionMoversErrorMessages</a></li><li><a href="global.html#getEventAttendance">getEventAttendance</a></li><li><a href="global.html#getEventSharingStatus">getEventSharingStatus</a></li><li><a href="global.html#getEventSummary">getEventSummary</a></li><li><a href="global.html#getEvents">getEvents</a></li><li><a href="global.html#getFlexiRecords">getFlexiRecords</a></li><li><a href="global.html#getFlexiStructure">getFlexiStructure</a></li><li><a href="global.html#getListOfMembers">getListOfMembers</a></li><li><a href="global.html#getMembersGrid">getMembersGrid</a></li><li><a href="global.html#getMostRecentTermId">getMostRecentTermId</a></li><li><a href="global.html#getSharedEventAttendance">getSharedEventAttendance</a></li><li><a href="global.html#getSingleFlexiRecord">getSingleFlexiRecord</a></li><li><a href="global.html#getStartupData">getStartupData</a></li><li><a href="global.html#getTerms">getTerms</a></li><li><a href="global.html#getUserAccessibleSections">getUserAccessibleSections</a></li><li><a href="global.html#getUserRoles">getUserRoles</a></li><li><a href="global.html#groupContactInfo">groupContactInfo</a></li><li><a href="global.html#groupEventsByName">groupEventsByName</a></li><li><a href="global.html#handleAPIResponseWithRateLimit">handleAPIResponseWithRateLimit</a></li><li><a href="global.html#handlePhoneCall">handlePhoneCall</a></li><li><a href="global.html#initializeDemoMode">initializeDemoMode</a></li><li><a href="global.html#isDemoMode">isDemoMode</a></li><li><a href="global.html#isSharedEventOwner">isSharedEventOwner</a></li><li><a href="global.html#isValidPhoneNumber">isValidPhoneNumber</a></li><li><a href="global.html#logRateLimitInfo">logRateLimitInfo</a></li><li><a href="global.html#mergeSharedAndSectionAttendance">mergeSharedAndSectionAttendance</a></li><li><a href="global.html#multiUpdateFlexiRecord">multiUpdateFlexiRecord</a></li><li><a href="global.html#organizeByCampGroups">organizeByCampGroups</a></li><li><a href="global.html#parseTimestamp">parseTimestamp</a></li><li><a href="global.html#quickValidateVikingSectionMovers">quickValidateVikingSectionMovers</a></li><li><a href="global.html#retrieveUserInfo">retrieveUserInfo</a></li><li><a href="global.html#safeCacheWithLogging">safeCacheWithLogging</a></li><li><a href="global.html#safeGetItem">safeGetItem</a></li><li><a href="global.html#safeGetSessionItem">safeGetSessionItem</a></li><li><a href="global.html#safeSetItem">safeSetItem</a></li><li><a href="global.html#safeSetSessionItem">safeSetSessionItem</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#sleepWithAbort">sleepWithAbort</a></li><li><a href="global.html#testBackendConnection">testBackendConnection</a></li><li><a href="global.html#updateFlexiRecord">updateFlexiRecord</a></li><li><a href="global.html#useAttendanceData">useAttendanceData</a></li><li><a href="global.html#useSignInOut">useSignInOut</a></li><li><a href="global.html#validateMemberMove">validateMemberMove</a></li><li><a href="global.html#validateTokenBeforeAPICall">validateTokenBeforeAPICall</a></li><li><a href="global.html#validateVikingSectionMoversFlexiRecord">validateVikingSectionMoversFlexiRecord</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Sep 12 2025 17:57:38 GMT+0100 (British Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
