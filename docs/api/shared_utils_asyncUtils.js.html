<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: shared/utils/asyncUtils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: shared/utils/asyncUtils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Async utility functions for Vikings Event Management Mobile
import { sentryUtils } from '../services/utils/sentry.js';
import logger, { LOG_CATEGORIES } from '../services/utils/logger.js';

/**
 * Sleep for a specified number of milliseconds
 * Provides a simple delay mechanism commonly used for rate limiting and timing control
 * 
 * @param {number} ms - Milliseconds to sleep (must be positive number)
 * @returns {Promise&lt;void>} Promise that resolves after the delay
 * @throws {Error} If ms is not a valid positive number
 * 
 * @example
 * // Simple delay for rate limiting
 * await sleep(1000); // Wait 1 second
 * 
 * // Progressive delays in retry logic
 * for (let i = 0; i &lt; 3; i++) {
 *   try {
 *     await apiCall();
 *     break;
 *   } catch (error) {
 *     await sleep(1000 * Math.pow(2, i)); // Exponential backoff
 *   }
 * }
 */
export const sleep = (ms) => {
  // Input validation
  if (typeof ms !== 'number' || ms &lt; 0 || !isFinite(ms)) {
    const error = new Error(`Invalid sleep duration: ${ms}. Must be a positive finite number.`);
    
    logger.error('Invalid sleep duration', {
      providedValue: ms,
      providedType: typeof ms,
      isFinite: isFinite(ms),
    }, LOG_CATEGORIES.ERROR);
    
    sentryUtils.captureException(error, {
      tags: {
        operation: 'async_utils_sleep',
        validation_error: true,
      },
      contexts: {
        input: {
          value: ms,
          type: typeof ms,
          isFinite: isFinite(ms),
        },
      },
    });
    
    throw error;
  }

  return new Promise(resolve => {
    setTimeout(resolve, ms);
  });
};

/**
 * Sleep with timeout abort capability for cancellable operations
 * Useful for operations that need to be cancelled mid-flight
 * 
 * @param {number} ms - Milliseconds to sleep (must be positive number)
 * @param {AbortSignal} [signal] - Optional abort signal to cancel the sleep
 * @returns {Promise&lt;void>} Promise that resolves after delay or rejects if aborted
 * @throws {Error} If ms is invalid or if operation is aborted
 * 
 * @example
 * // Cancellable delay with timeout
 * const controller = new AbortController();
 * 
 * try {
 *   // Cancel after 5 seconds
 *   setTimeout(() => controller.abort(), 5000);
 *   await sleepWithAbort(10000, controller.signal); // Will be cancelled
 * } catch (error) {
 *   console.log('Sleep was cancelled');
 * }
 */
export const sleepWithAbort = (ms, signal) => {
  // Input validation
  if (typeof ms !== 'number' || ms &lt; 0 || !isFinite(ms)) {
    const error = new Error(`Invalid sleep duration: ${ms}. Must be a positive finite number.`);
    
    logger.error('Invalid sleepWithAbort duration', {
      providedValue: ms,
      providedType: typeof ms,
      isFinite: isFinite(ms),
      hasSignal: !!signal,
    }, LOG_CATEGORIES.ERROR);
    
    throw error;
  }

  return new Promise((resolve, reject) => {
    // Check if already aborted
    if (signal?.aborted) {
      const abortError = new Error('Sleep aborted before starting');
      
      logger.debug('Sleep aborted before starting', {
        duration: ms,
        abortReason: signal.reason || 'Unknown',
      }, LOG_CATEGORIES.APP);
      
      reject(abortError);
      return;
    }
    
    const timeoutId = setTimeout(() => {
      logger.debug('Sleep completed successfully', { duration: ms }, LOG_CATEGORIES.APP);
      resolve();
    }, ms);
    
    // Set up abort listener
    const abortHandler = () => {
      clearTimeout(timeoutId);
      
      const abortError = new Error('Sleep aborted');
      abortError.cause = signal?.reason;
      
      logger.debug('Sleep aborted mid-flight', {
        duration: ms,
        abortReason: signal?.reason || 'Unknown',
      }, LOG_CATEGORIES.APP);
      
      reject(abortError);
    };
    
    signal?.addEventListener('abort', abortHandler, { once: true });
  });
};

/**
 * Parse a timestamp to epoch milliseconds with robust handling
 * Handles various timestamp formats consistently across the application
 * 
 * @param {string|number|Date} timestamp - Timestamp in various formats
 * @returns {number|null} Epoch milliseconds or null if invalid
 * 
 * @example
 * // String epoch timestamp
 * parseTimestamp('1640995200000') // → 1640995200000
 * 
 * // ISO string
 * parseTimestamp('2022-01-01T00:00:00.000Z') // → 1640995200000
 * 
 * // Number epoch
 * parseTimestamp(1640995200000) // → 1640995200000
 * 
 * // Date object
 * parseTimestamp(new Date('2022-01-01')) // → 1640995200000
 * 
 * // Invalid timestamp
 * parseTimestamp('invalid') // → null
 */
export const parseTimestamp = (timestamp) => {
  if (!timestamp) return null;

  const now = Date.now();
  let syncTimeMs;

  try {
    // Handle different timestamp formats
    if (typeof timestamp === 'string') {
      if (/^\d+$/.test(timestamp)) {
        // Epoch timestamp as string (standard format)
        syncTimeMs = parseInt(timestamp, 10);
      } else {
        // ISO string (legacy format) 
        syncTimeMs = new Date(timestamp).getTime();
      }
    } else if (typeof timestamp === 'number') {
      // Epoch timestamp as number
      syncTimeMs = timestamp;
    } else {
      // Date object or other types
      syncTimeMs = new Date(timestamp).getTime();
    }
    
    // Validate the parsed timestamp
    if (Number.isNaN(syncTimeMs) || syncTimeMs &lt;= 0) {
      logger.debug('Invalid timestamp parsed to NaN or non-positive', {
        originalTimestamp: timestamp,
        originalType: typeof timestamp,
        parsedValue: syncTimeMs,
      }, LOG_CATEGORIES.APP);
      return null;
    }
    
    // Sanity check: reject timestamps too far in the future (more than 1 day)
    if (syncTimeMs > now + 24 * 60 * 60 * 1000) {
      logger.warn('Timestamp parsing: far future timestamp rejected', {
        originalTimestamp: timestamp,
        parsedDate: new Date(syncTimeMs).toISOString(),
        futureByMs: syncTimeMs - now,
      }, LOG_CATEGORIES.APP);
      return null;
    }
    
    return syncTimeMs;
    
  } catch (error) {
    logger.error('Error parsing timestamp', {
      originalTimestamp: timestamp,
      originalType: typeof timestamp,
      error: error.message,
    }, LOG_CATEGORIES.ERROR);
    
    sentryUtils.captureException(error, {
      tags: {
        operation: 'parse_timestamp',
      },
      contexts: {
        input: {
          timestamp,
          type: typeof timestamp,
        },
      },
    });
    
    return null;
  }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-DatabaseService.html">DatabaseService</a></li><li><a href="module-EventCard.html">EventCard</a></li><li><a href="module-FlexiRecordService.html">FlexiRecordService</a></li><li><a href="module-ageUtils.html">ageUtils</a></li><li><a href="module-auth.html">auth</a></li><li><a href="module-cacheCleanup.html">cacheCleanup</a></li><li><a href="module-flexiRecordTransforms.html">flexiRecordTransforms</a></li><li><a href="module-logger.html">logger</a></li><li><a href="module-notifications.html">notifications</a></li><li><a href="module-sectionHelpers.html">sectionHelpers</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-logger-logger.html">logger</a></li></ul><h3>Classes</h3><ul><li><a href="APIQueue.html">APIQueue</a></li><li><a href="ErrorBoundary.html">ErrorBoundary</a></li><li><a href="RateLimitQueue.html">RateLimitQueue</a></li><li><a href="SyncService.html">SyncService</a></li><li><a href="module-DatabaseService-DatabaseService.html">DatabaseService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Alert">Alert</a></li><li><a href="global.html#App">App</a></li><li><a href="global.html#AppContent">AppContent</a></li><li><a href="global.html#AppRouter">AppRouter</a></li><li><a href="global.html#AuthButton">AuthButton</a></li><li><a href="global.html#CampGroupCard">CampGroupCard</a></li><li><a href="global.html#CampGroupsView">CampGroupsView</a></li><li><a href="global.html#ConfirmModal">ConfirmModal</a></li><li><a href="global.html#DEMO_CACHE_DATA">DEMO_CACHE_DATA</a></li><li><a href="global.html#GroupNamesEditModal">GroupNamesEditModal</a></li><li><a href="global.html#Modal">Modal</a></li><li><a href="global.html#REQUIRED_VIKING_SECTION_MOVERS_FIELDS">REQUIRED_VIKING_SECTION_MOVERS_FIELDS</a></li><li><a href="global.html#SectionFilter">SectionFilter</a></li><li><a href="global.html#_generateProductionFormatAttendance">_generateProductionFormatAttendance</a></li><li><a href="global.html#assignMemberToCampGroupDemo">assignMemberToCampGroupDemo</a></li><li><a href="global.html#batchAssignMembers">batchAssignMembers</a></li><li><a href="global.html#buildEventCard">buildEventCard</a></li><li><a href="global.html#checkNetworkStatus">checkNetworkStatus</a></li><li><a href="global.html#clearFlexiRecordCaches">clearFlexiRecordCaches</a></li><li><a href="global.html#cn">cn</a></li><li><a href="global.html#convertSharedEventToAttendanceFormat">convertSharedEventToAttendanceFormat</a></li><li><a href="global.html#demoConfig">demoConfig</a></li><li><a href="global.html#expandSharedEvents">expandSharedEvents</a></li><li><a href="global.html#extractFlexiRecordContext">extractFlexiRecordContext</a></li><li><a href="global.html#fetchAllSectionEvents">fetchAllSectionEvents</a></li><li><a href="global.html#fetchEventAttendance">fetchEventAttendance</a></li><li><a href="global.html#fetchMostRecentTermId">fetchMostRecentTermId</a></li><li><a href="global.html#fetchSectionEvents">fetchSectionEvents</a></li><li><a href="global.html#filterEventsByDateRange">filterEventsByDateRange</a></li><li><a href="global.html#formatPhoneForCall">formatPhoneForCall</a></li><li><a href="global.html#generateDemoSharedAttendance">generateDemoSharedAttendance</a></li><li><a href="global.html#generateVikingSectionMoversErrorMessages">generateVikingSectionMoversErrorMessages</a></li><li><a href="global.html#getEventAttendance">getEventAttendance</a></li><li><a href="global.html#getEventSharingStatus">getEventSharingStatus</a></li><li><a href="global.html#getEventSummary">getEventSummary</a></li><li><a href="global.html#getEvents">getEvents</a></li><li><a href="global.html#getFlexiRecords">getFlexiRecords</a></li><li><a href="global.html#getFlexiStructure">getFlexiStructure</a></li><li><a href="global.html#getListOfMembers">getListOfMembers</a></li><li><a href="global.html#getMembersGrid">getMembersGrid</a></li><li><a href="global.html#getMostRecentTermId">getMostRecentTermId</a></li><li><a href="global.html#getSharedEventAttendance">getSharedEventAttendance</a></li><li><a href="global.html#getSingleFlexiRecord">getSingleFlexiRecord</a></li><li><a href="global.html#getStartupData">getStartupData</a></li><li><a href="global.html#getTerms">getTerms</a></li><li><a href="global.html#getUserAccessibleSections">getUserAccessibleSections</a></li><li><a href="global.html#getUserRoles">getUserRoles</a></li><li><a href="global.html#groupContactInfo">groupContactInfo</a></li><li><a href="global.html#groupEventsByName">groupEventsByName</a></li><li><a href="global.html#handleAPIResponseWithRateLimit">handleAPIResponseWithRateLimit</a></li><li><a href="global.html#handlePhoneCall">handlePhoneCall</a></li><li><a href="global.html#initializeDemoMode">initializeDemoMode</a></li><li><a href="global.html#isDemoMode">isDemoMode</a></li><li><a href="global.html#isSharedEventOwner">isSharedEventOwner</a></li><li><a href="global.html#isValidPhoneNumber">isValidPhoneNumber</a></li><li><a href="global.html#logRateLimitInfo">logRateLimitInfo</a></li><li><a href="global.html#mergeSharedAndSectionAttendance">mergeSharedAndSectionAttendance</a></li><li><a href="global.html#multiUpdateFlexiRecord">multiUpdateFlexiRecord</a></li><li><a href="global.html#organizeByCampGroups">organizeByCampGroups</a></li><li><a href="global.html#parseTimestamp">parseTimestamp</a></li><li><a href="global.html#quickValidateVikingSectionMovers">quickValidateVikingSectionMovers</a></li><li><a href="global.html#retrieveUserInfo">retrieveUserInfo</a></li><li><a href="global.html#safeCacheWithLogging">safeCacheWithLogging</a></li><li><a href="global.html#safeGetItem">safeGetItem</a></li><li><a href="global.html#safeGetSessionItem">safeGetSessionItem</a></li><li><a href="global.html#safeSetItem">safeSetItem</a></li><li><a href="global.html#safeSetSessionItem">safeSetSessionItem</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#sleepWithAbort">sleepWithAbort</a></li><li><a href="global.html#testBackendConnection">testBackendConnection</a></li><li><a href="global.html#updateFlexiRecord">updateFlexiRecord</a></li><li><a href="global.html#useAttendanceData">useAttendanceData</a></li><li><a href="global.html#useSignInOut">useSignInOut</a></li><li><a href="global.html#validateMemberMove">validateMemberMove</a></li><li><a href="global.html#validateTokenBeforeAPICall">validateTokenBeforeAPICall</a></li><li><a href="global.html#validateVikingSectionMoversFlexiRecord">validateVikingSectionMoversFlexiRecord</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Sep 12 2025 17:57:38 GMT+0100 (British Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
