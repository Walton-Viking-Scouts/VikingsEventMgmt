<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: shared/services/api/api/members.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: shared/services/api/api/members.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Members API service
// Extracted from monolithic api.js for better modularity

import {
  BACKEND_URL,
  validateTokenBeforeAPICall,
  handleAPIResponseWithRateLimit,
} from './base.js';
import { withRateLimitQueue } from '../../../utils/rateLimitQueue.js';
import { checkNetworkStatus } from '../../../utils/networkUtils.js';
import { isDemoMode } from '../../../../config/demoMode.js';
import { authHandler } from '../../auth/authHandler.js';
import { getMostRecentTermId } from '../../../utils/termUtils.js';
import { getTerms } from './terms.js';
import databaseService from '../../storage/database.js';
import logger, { LOG_CATEGORIES } from '../../utils/logger.js';

/**
 * Retrieves comprehensive member data for a section using the enhanced grid API
 * Includes contact information, patrol assignments, and member status
 * @param {number|string} sectionId - OSM section identifier
 * @param {number|string} termId - OSM term identifier
 * @param {string} token - OSM authentication token
 * @returns {Promise&lt;Array&lt;Object>>} Array of member objects with normalized data
 * @throws {Error} When API request fails and no cached data available
 * 
 * @example
 * const members = await getMembersGrid(123, '456', token);
 * members.forEach(member => {
 *   console.log(`${member.firstname} ${member.lastname} (${member.person_type})`);
 * });
 */
export async function getMembersGrid(sectionId, termId, token) {
  try {
    // Skip API calls in demo mode - use cached data only
    const demoMode = isDemoMode();
    if (demoMode) {
      const cachedMembers = await databaseService.getMembers([sectionId]);
      logger.debug('Demo mode: Using cached members from database service', {
        sectionId,
        memberCount: cachedMembers.length,
      }, LOG_CATEGORIES.API);
      return cachedMembers;
    }

    // Check network status first
    const isOnline = await checkNetworkStatus();
    
    // If offline, get from local database (fallback to old format)
    if (!isOnline) {
      const cachedMembers = await databaseService.getMembers([sectionId]);
      return cachedMembers;
    }

    // Validate token before making API call
    validateTokenBeforeAPICall(token, 'getMembersGrid');

    // Simple circuit breaker - use cache if auth already failed
    if (!authHandler.shouldMakeAPICall()) {
      logger.info('Auth failed - using cached members only', { sectionId }, LOG_CATEGORIES.API);
      const cachedMembers = await databaseService.getMembers([sectionId]);
      return cachedMembers;
    }

    const data = await withRateLimitQueue(async () => {
      const response = await fetch(`${BACKEND_URL}/get-members-grid`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify({
          section_id: sectionId,
          term_id: termId,
        }),
      });
      
      return await handleAPIResponseWithRateLimit(response, 'getMembersGrid');
    });
    
    // Transform the grid data into a more usable format
    if (data &amp;&amp; data.data &amp;&amp; data.data.members) {
      const transformedMembers = (Array.isArray(data?.data?.members) ? data.data.members : [])
        .map(member => {
          const scoutId = Number(member.member_id ?? member.scoutid);
          const sectionIdNum = Number(member.section_id ?? member.sectionid);
          const patrolId = Number(member.patrol_id ?? member.patrolid);
          let person_type = 'Young People';
          if (patrolId === -2) person_type = 'Leaders';
          else if (patrolId === -3) person_type = 'Young Leaders';

          return {
            ...member,
            // Core member info (normalised)
            scoutid: scoutId,
            member_id: scoutId,
            firstname: member.first_name ?? member.firstname,
            lastname: member.last_name ?? member.lastname,
            date_of_birth: member.date_of_birth ?? member.dob,
            age: typeof member.age === 'string' ? Number(member.age) : member.age,
            // Section info
            sectionid: sectionIdNum,
            patrol: member.patrol,
            patrol_id: patrolId,
            person_type,
            started: member.started,
            joined: member.joined,
            active: member.active,
            end_date: member.end_date,
            // Photo info
            photo_guid: member.photo_guid,
            has_photo: (() => {
              const v = member.has_photo ?? member.pic ?? member.photo_guid;
              return typeof v === 'string'
                ? ['1', 'y', 'true'].includes(v.toLowerCase())
                : Boolean(v);
            })(),
            // Backward-compatible grouped contacts
            contact_groups: member.contact_groups,
          };
        })
        .filter(m => Number.isFinite(m.scoutid) &amp;&amp; Number.isFinite(m.sectionid));
      
      // CRITICAL FIX: Save the transformed members to cache
      try {
        await databaseService.saveMembers([sectionId], transformedMembers);
        logger.info('Members successfully cached', {
          sectionId,
          memberCount: transformedMembers.length,
        }, LOG_CATEGORIES.API);
      } catch (saveError) {
        logger.error('Failed to save members to cache', {
          sectionId,
          error: saveError.message,
          memberCount: transformedMembers.length,
        }, LOG_CATEGORIES.ERROR);
        // Don't throw - return the data even if caching fails
      }
      
      return transformedMembers;
    }

    return [];

  } catch (error) {
    logger.error('Error fetching members grid', { sectionId, error: error.message }, LOG_CATEGORIES.API);
    
    // If online request fails, try local database as fallback
    const isOnline = await checkNetworkStatus();
    if (isOnline) {
      try {
        const cachedMembers = await databaseService.getMembers([sectionId]);
        return cachedMembers;
      } catch (dbError) {
        logger.error('Database fallback failed', { dbError: dbError.message }, LOG_CATEGORIES.API);
      }
    }
    
    throw error;
  }
}

/**
 * Retrieves members across multiple sections with deduplication
 * Optimized to load terms once and reuse for all sections
 * @param {Array&lt;Object>} sections - Array of section objects with sectionid
 * @param {string} token - OSM authentication token
 * @returns {Promise&lt;Array&lt;Object>>} Deduplicated array of members with section assignments
 * @throws {Error} When offline with no cached data or API requests fail
 * 
 * @example
 * const allMembers = await getListOfMembers([
 *   { sectionid: 123, sectionname: 'Beavers' },
 *   { sectionid: 456, sectionname: 'Cubs' }
 * ], token);
 * console.log(`Total unique members: ${allMembers.length}`);
 */
export async function getListOfMembers(sections, token) {
  // Skip API calls in demo mode - use cached data only
  const demoMode = isDemoMode();
  if (demoMode) {
    const validSections = sections.filter(section => section.sectionid);
    const sectionIds = validSections.map(s => s.sectionid);
    const cachedMembers = await databaseService.getMembers(sectionIds);
    logger.debug('Demo mode: Using cached members from database service', {
      sectionCount: validSections.length,
      memberCount: cachedMembers.length,
    }, LOG_CATEGORIES.API);
    return cachedMembers;
  }

  // Check network status first
  const isOnline = await checkNetworkStatus();
  
  // Filter out sections with invalid IDs upfront
  const validSections = sections.filter(section => {
    if (!section.sectionid || section.sectionid === null || section.sectionid === undefined) {
      logger.warn('Filtering out section with invalid ID', {
        section: section,
        sectionKeys: Object.keys(section || {}),
      }, LOG_CATEGORIES.API);
      return false;
    }
    return true;
  });
  
  if (validSections.length === 0) {
    logger.error('No valid sections provided to getListOfMembers', {
      originalCount: sections.length,
      sections: sections,
    }, LOG_CATEGORIES.ERROR);
    return [];
  }
  
  const sectionIds = validSections.map(s => s.sectionid);
  
  // Try cache first (both online and offline)
  try {
    const cachedMembers = await databaseService.getMembers(sectionIds);
    if (cachedMembers.length > 0) {
      logger.info(`Using cached members: ${cachedMembers.length} members for sections ${sectionIds.join(', ')}`);
      return cachedMembers;
    }
  } catch (error) {
    logger.warn('Failed to get cached members:', error);
  }
  
  // If offline and no cache, throw error
  if (!isOnline) {
    logger.error('Offline mode - no cached members available');
    throw new Error('Unable to retrieve members while offline and no cache available');
  }

  // Online mode - fetch from API if cache is empty
  const memberMap = new Map(); // For deduplication by scoutid
  
  // Load terms once for all sections (major optimization!)
  logger.info('Loading terms once for all sections', {}, LOG_CATEGORIES.API);
  const allTerms = await getTerms(token);
  
  for (const section of validSections) {
    try {
      // Use cached terms instead of calling API again
      // Defensive check for section ID
      if (!section.sectionid || section.sectionid === null || section.sectionid === undefined) {
        logger.warn('Skipping section with invalid ID in getListOfMembers', {
          section: section,
          sectionKeys: Object.keys(section),
        }, LOG_CATEGORIES.API);
        continue;
      }
      
      const termId = getMostRecentTermId(section.sectionid, allTerms);
      if (!termId) continue;
      
      // Use the new getMembersGrid API for comprehensive data
      const members = await getMembersGrid(section.sectionid, termId, token);
      
      members.forEach(member => {
        if (member &amp;&amp; member.scoutid) {
          const scoutId = member.scoutid;
          
          if (memberMap.has(scoutId)) {
            // Member already exists, add section to their sections list
            const existingMember = memberMap.get(scoutId);
            if (!existingMember.sections) {
              existingMember.sections = [existingMember.sectionname];
            }
            if (!existingMember.sections.includes(section.sectionname)) {
              existingMember.sections.push(section.sectionname);
            }
          } else {
            // New member, add to map with section info
            memberMap.set(scoutId, {
              ...member,
              sectionname: section.sectionname,
              section: section.section,
              sections: [section.sectionname], // Track all sections this member belongs to
            });
          }
        }
      });
      
    } catch (sectionError) {
      logger.warn('Failed to fetch members for section', { sectionId: section.sectionid, error: sectionError.message }, LOG_CATEGORIES.API);
      // Continue with other sections
    }
  }
  
  // Convert map back to array
  const members = Array.from(memberMap.values());
  
  // Cache the members for offline use
  if (members.length > 0) {
    try {
      await databaseService.saveMembers(sectionIds, members);
      logger.info(`Cached ${members.length} members for offline use`);
    } catch (error) {
      logger.warn('Failed to cache members:', error);
      // Don't throw error - this is not critical for the main flow
    }
  }
  
  return members;
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-DatabaseService.html">DatabaseService</a></li><li><a href="module-EventCard.html">EventCard</a></li><li><a href="module-FlexiRecordService.html">FlexiRecordService</a></li><li><a href="module-ageUtils.html">ageUtils</a></li><li><a href="module-auth.html">auth</a></li><li><a href="module-cacheCleanup.html">cacheCleanup</a></li><li><a href="module-flexiRecordTransforms.html">flexiRecordTransforms</a></li><li><a href="module-logger.html">logger</a></li><li><a href="module-notifications.html">notifications</a></li><li><a href="module-sectionHelpers.html">sectionHelpers</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-logger-logger.html">logger</a></li></ul><h3>Classes</h3><ul><li><a href="APIQueue.html">APIQueue</a></li><li><a href="ErrorBoundary.html">ErrorBoundary</a></li><li><a href="RateLimitQueue.html">RateLimitQueue</a></li><li><a href="SyncService.html">SyncService</a></li><li><a href="module-DatabaseService-DatabaseService.html">DatabaseService</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Alert">Alert</a></li><li><a href="global.html#AuthButton">AuthButton</a></li><li><a href="global.html#CampGroupCard">CampGroupCard</a></li><li><a href="global.html#CampGroupsView">CampGroupsView</a></li><li><a href="global.html#ConfirmModal">ConfirmModal</a></li><li><a href="global.html#DEMO_CACHE_DATA">DEMO_CACHE_DATA</a></li><li><a href="global.html#GroupNamesEditModal">GroupNamesEditModal</a></li><li><a href="global.html#Modal">Modal</a></li><li><a href="global.html#REQUIRED_VIKING_SECTION_MOVERS_FIELDS">REQUIRED_VIKING_SECTION_MOVERS_FIELDS</a></li><li><a href="global.html#SectionFilter">SectionFilter</a></li><li><a href="global.html#_generateProductionFormatAttendance">_generateProductionFormatAttendance</a></li><li><a href="global.html#assignMemberToCampGroupDemo">assignMemberToCampGroupDemo</a></li><li><a href="global.html#batchAssignMembers">batchAssignMembers</a></li><li><a href="global.html#buildEventCard">buildEventCard</a></li><li><a href="global.html#checkNetworkStatus">checkNetworkStatus</a></li><li><a href="global.html#clearFlexiRecordCaches">clearFlexiRecordCaches</a></li><li><a href="global.html#cn">cn</a></li><li><a href="global.html#convertSharedEventToAttendanceFormat">convertSharedEventToAttendanceFormat</a></li><li><a href="global.html#demoConfig">demoConfig</a></li><li><a href="global.html#expandSharedEvents">expandSharedEvents</a></li><li><a href="global.html#extractFlexiRecordContext">extractFlexiRecordContext</a></li><li><a href="global.html#fetchAllSectionEvents">fetchAllSectionEvents</a></li><li><a href="global.html#fetchEventAttendance">fetchEventAttendance</a></li><li><a href="global.html#fetchMostRecentTermId">fetchMostRecentTermId</a></li><li><a href="global.html#fetchSectionEvents">fetchSectionEvents</a></li><li><a href="global.html#filterEventsByDateRange">filterEventsByDateRange</a></li><li><a href="global.html#formatPhoneForCall">formatPhoneForCall</a></li><li><a href="global.html#generateDemoSharedAttendance">generateDemoSharedAttendance</a></li><li><a href="global.html#generateVikingSectionMoversErrorMessages">generateVikingSectionMoversErrorMessages</a></li><li><a href="global.html#getEventAttendance">getEventAttendance</a></li><li><a href="global.html#getEventSharingStatus">getEventSharingStatus</a></li><li><a href="global.html#getEventSummary">getEventSummary</a></li><li><a href="global.html#getEvents">getEvents</a></li><li><a href="global.html#getFlexiRecords">getFlexiRecords</a></li><li><a href="global.html#getFlexiStructure">getFlexiStructure</a></li><li><a href="global.html#getListOfMembers">getListOfMembers</a></li><li><a href="global.html#getMembersGrid">getMembersGrid</a></li><li><a href="global.html#getMostRecentTermId">getMostRecentTermId</a></li><li><a href="global.html#getSharedEventAttendance">getSharedEventAttendance</a></li><li><a href="global.html#getSingleFlexiRecord">getSingleFlexiRecord</a></li><li><a href="global.html#getStartupData">getStartupData</a></li><li><a href="global.html#getTerms">getTerms</a></li><li><a href="global.html#getUserAccessibleSections">getUserAccessibleSections</a></li><li><a href="global.html#getUserRoles">getUserRoles</a></li><li><a href="global.html#groupContactInfo">groupContactInfo</a></li><li><a href="global.html#groupEventsByName">groupEventsByName</a></li><li><a href="global.html#handleAPIResponseWithRateLimit">handleAPIResponseWithRateLimit</a></li><li><a href="global.html#handlePhoneCall">handlePhoneCall</a></li><li><a href="global.html#initializeDemoMode">initializeDemoMode</a></li><li><a href="global.html#isDemoMode">isDemoMode</a></li><li><a href="global.html#isSharedEventOwner">isSharedEventOwner</a></li><li><a href="global.html#isValidPhoneNumber">isValidPhoneNumber</a></li><li><a href="global.html#logRateLimitInfo">logRateLimitInfo</a></li><li><a href="global.html#mergeSharedAndSectionAttendance">mergeSharedAndSectionAttendance</a></li><li><a href="global.html#multiUpdateFlexiRecord">multiUpdateFlexiRecord</a></li><li><a href="global.html#organizeByCampGroups">organizeByCampGroups</a></li><li><a href="global.html#parseTimestamp">parseTimestamp</a></li><li><a href="global.html#quickValidateVikingSectionMovers">quickValidateVikingSectionMovers</a></li><li><a href="global.html#retrieveUserInfo">retrieveUserInfo</a></li><li><a href="global.html#safeCacheWithLogging">safeCacheWithLogging</a></li><li><a href="global.html#safeGetItem">safeGetItem</a></li><li><a href="global.html#safeGetSessionItem">safeGetSessionItem</a></li><li><a href="global.html#safeSetItem">safeSetItem</a></li><li><a href="global.html#safeSetSessionItem">safeSetSessionItem</a></li><li><a href="global.html#sleep">sleep</a></li><li><a href="global.html#sleepWithAbort">sleepWithAbort</a></li><li><a href="global.html#testBackendConnection">testBackendConnection</a></li><li><a href="global.html#updateFlexiRecord">updateFlexiRecord</a></li><li><a href="global.html#useAttendanceData">useAttendanceData</a></li><li><a href="global.html#useSignInOut">useSignInOut</a></li><li><a href="global.html#validateMemberMove">validateMemberMove</a></li><li><a href="global.html#validateTokenBeforeAPICall">validateTokenBeforeAPICall</a></li><li><a href="global.html#validateVikingSectionMoversFlexiRecord">validateVikingSectionMoversFlexiRecord</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Fri Sep 12 2025 15:24:48 GMT+0100 (British Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
